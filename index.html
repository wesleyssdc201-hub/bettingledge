<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Betting Ledger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/e9c25d7677.js" crossorigin="anonymous"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c0c0c;
            color: #E5E5E5;
        }
        .tab-button {
            border-bottom: 3px solid transparent;
            transition: border-color 0.3s ease;
        }
        .tab-button.active {
            border-bottom-color: #E5E5E5;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        .lds-dual-ring {
            display: inline-block;
            width: 20px;
            height: 20px;
        }
        .lds-dual-ring:after {
            content: " ";
            display: block;
            width: 16px;
            height: 16px;
            margin: 1px;
            border-radius: 50%;
            border: 3px solid #fff;
            border-color: #A3A3A3 transparent #A3A3A3 transparent;
            animation: lds-dual-ring 1.2s linear infinite;
        }
        @keyframes lds-dual-ring {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-zinc-950 text-neutral-200 p-4 min-h-screen flex flex-col items-center">

    <div id="auth-container" class="bg-zinc-800 p-8 rounded-lg shadow-lg w-full max-w-sm mt-20">
        <h2 class="text-2xl font-bold mb-6 text-center">Login</h2>
        <div class="space-y-4">
            <input type="email" id="email-input" placeholder="Email" class="w-full p-3 bg-zinc-700 rounded-md border border-zinc-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <input type="password" id="password-input" placeholder="Senha" class="w-full p-3 bg-zinc-700 rounded-md border border-zinc-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <div class="flex justify-between space-x-2 mt-4">
                <button id="login-button" class="flex-1 bg-indigo-600 text-white p-3 rounded-md font-semibold hover:bg-indigo-700 transition duration-300">Entrar</button>
                <button id="register-button" class="flex-1 bg-zinc-600 text-white p-3 rounded-md font-semibold hover:bg-zinc-700 transition duration-300">Cadastrar</button>
            </div>
        </div>
    </div>

    <div id="main-content" class="w-full max-w-5xl mx-auto hidden">
        <header class="flex justify-between items-center py-4 mb-4 border-b border-zinc-700">
            <h1 class="text-3xl font-bold">Betting Ledger</h1>
            <div class="flex items-center space-x-4">
                <span id="user-display" class="text-sm text-neutral-400"></span>
                <button id="logout-button" class="bg-zinc-700 text-white px-3 py-1 rounded-md text-sm hover:bg-zinc-600 transition duration-300">Sair</button>
            </div>
        </header>

        <div class="flex space-x-4 mb-4">
            <button id="bets-tab" class="tab-button active pb-2">Apostas</button>
            <button id="people-tab" class="tab-button pb-2">Pessoas & Plataformas</button>
            <button id="dashboard-tab" class="tab-button pb-2">Dashboard</button>
        </div>

        <div id="bets-content" class="tab-content active space-y-8">
            <div class="bg-zinc-800 p-4 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Adicionar Nova Aposta</h3>
                <form id="addBetForm" class="space-y-4">
                    <div>
                        <label for="date" class="block text-sm font-medium text-neutral-400">Data</label>
                        <input type="date" id="date" name="date" required class="mt-1 block w-full bg-zinc-700 border border-zinc-600 rounded-md shadow-sm text-neutral-200">
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium text-neutral-400">Descrição</label>
                        <input type="text" id="description" name="description" required class="mt-1 block w-full bg-zinc-700 border border-zinc-600 rounded-md shadow-sm text-neutral-200">
                    </div>
                    <div>
                        <label for="bet-person-id" class="block text-sm font-medium text-neutral-400">Pessoa</label>
                        <select id="bet-person-id" name="person" required class="mt-1 block w-full bg-zinc-700 border border-zinc-600 rounded-md shadow-sm text-neutral-200">
                            <option value="">Selecione uma pessoa</option>
                        </select>
                    </div>
                    <div>
                        <label for="bet-platform-id" class="block text-sm font-medium text-neutral-400">Plataforma</label>
                        <select id="bet-platform-id" name="platform" required class="mt-1 block w-full bg-zinc-700 border border-zinc-600 rounded-md shadow-sm text-neutral-200">
                            <option value="">Selecione uma plataforma</option>
                        </select>
                    </div>
                    <div>
                        <label for="type" class="block text-sm font-medium text-neutral-400">Tipo</label>
                        <input type="text" id="type" name="type" required class="mt-1 block w-full bg-zinc-700 border border-zinc-600 rounded-md shadow-sm text-neutral-200">
                    </div>
                    <div>
                        <label for="stake" class="block text-sm font-medium text-neutral-400">Stake</label>
                        <input type="number" id="stake" name="stake" required step="0.01" class="mt-1 block w-full bg-zinc-700 border border-zinc-600 rounded-md shadow-sm text-neutral-200">
                    </div>
                    <div>
                        <label for="odds" class="block text-sm font-medium text-neutral-400">Odds</label>
                        <input type="number" id="odds" name="odds" required step="0.01" class="mt-1 block w-full bg-zinc-700 border border-zinc-600 rounded-md shadow-sm text-neutral-200">
                    </div>
                    <div>
                        <label for="result" class="block text-sm font-medium text-neutral-400">Resultado</label>
                        <select id="result" name="result" required class="mt-1 block w-full bg-zinc-700 border border-zinc-600 rounded-md shadow-sm text-neutral-200">
                            <option value="Green">Green</option>
                            <option value="Half Green">Half Green</option>
                            <option value="Red">Red</option>
                            <option value="Half Red">Half Red</option>
                            <option value="Void">Void</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md font-medium hover:bg-indigo-700 transition duration-300">
                        Adicionar Aposta
                    </button>
                </form>
            </div>
            
            <div class="bg-zinc-800 p-4 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Apostas Recentes</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-zinc-700">
                        <thead class="bg-zinc-700">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase">Data</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase">Descrição</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase">Pessoa</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase">Plataforma</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase">Tipo</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase">Stake</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase">Odds</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase">Resultado</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase">Retorno</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase">Lucro</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="bets-table-body" class="bg-zinc-800 divide-y divide-zinc-700">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="people-content" class="tab-content space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-zinc-800 p-4 rounded-lg shadow-lg">
                    <h3 class="text-lg font-semibold mb-4">Adicionar Nova Pessoa</h3>
                    <form id="addPersonForm" class="space-y-4">
                        <div>
                            <label for="person-name-input" class="block text-sm font-medium text-neutral-400">Nome</label>
                            <input type="text" id="person-name-input" name="name" required class="mt-1 block w-full bg-zinc-700 border border-zinc-600 rounded-md shadow-sm text-neutral-200">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md font-medium hover:bg-indigo-700 transition duration-300">
                            Adicionar Pessoa
                        </button>
                    </form>
                </div>
                
                <div class="bg-zinc-800 p-4 rounded-lg shadow-lg">
                    <h3 class="text-lg font-semibold mb-4">Adicionar Nova Plataforma</h3>
                    <form id="addPlatformForm" class="space-y-4">
                        <div>
                            <label for="platform-person-id" class="block text-sm font-medium text-neutral-400">Pessoa</label>
                            <select id="platform-person-id" name="person" required class="mt-1 block w-full bg-zinc-700 border border-zinc-600 rounded-md shadow-sm text-neutral-200">
                                <option value="">Selecione uma pessoa</option>
                            </select>
                        </div>
                        <div>
                            <label for="platform-name" class="block text-sm font-medium text-neutral-400">Nome da Plataforma</label>
                            <input type="text" id="platform-name" name="name" required class="mt-1 block w-full bg-zinc-700 border border-zinc-600 rounded-md shadow-sm text-neutral-200">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md font-medium hover:bg-indigo-700 transition duration-300">
                            Adicionar Plataforma
                        </button>
                    </form>
                </div>

                <div class="col-span-1 md:col-span-2 bg-zinc-800 p-4 rounded-lg shadow-lg">
                    <h3 class="text-lg font-semibold mb-4">Gerenciar Depósitos e Saques</h3>
                    <form id="addTransactionForm" class="space-y-4">
                        <div>
                            <label for="transaction-person-id" class="block text-sm font-medium text-neutral-400">Pessoa</label>
                            <select id="transaction-person-id" name="person" required
                                class="mt-1 block w-full bg-zinc-700 border border-zinc-600 rounded-md shadow-sm text-neutral-200">
                                <option value="">Selecione uma pessoa</option>
                            </select>
                        </div>
                        <div>
                            <label for="transaction-platform-id" class="block text-sm font-medium text-neutral-400">Plataforma</label>
                            <select id="transaction-platform-id" name="platform" required
                                class="mt-1 block w-full bg-zinc-700 border border-zinc-600 rounded-md shadow-sm text-neutral-200">
                                <option value="">Selecione uma plataforma</option>
                            </select>
                        </div>
                        <div>
                            <label for="transaction-type" class="block text-sm font-medium text-neutral-400">Tipo</label>
                            <select id="transaction-type" name="type" required
                                class="mt-1 block w-full bg-zinc-700 border border-zinc-600 rounded-md shadow-sm text-neutral-200">
                                <option value="Deposit">Depósito</option>
                                <option value="Withdrawal">Saque</option>
                            </select>
                        </div>
                        <div>
                            <label for="transaction-amount" class="block text-sm font-medium text-neutral-400">Valor</label>
                            <input type="number" id="transaction-amount" name="amount" required step="0.01"
                                class="mt-1 block w-full bg-zinc-700 border border-zinc-600 rounded-md shadow-sm text-neutral-200">
                        </div>
                        <button type="submit"
                            class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md font-medium hover:bg-indigo-700 transition duration-300">
                            Adicionar Transação
                        </button>
                    </form>
                </div>
            </div>

            <div class="bg-zinc-800 p-4 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Pessoas & Plataformas</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-zinc-700">
                        <thead class="bg-zinc-700">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase">Pessoa</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase">Plataforma</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="people-platforms-table-body" class="bg-zinc-800 divide-y divide-zinc-700">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="dashboard-content" class="tab-content space-y-8">
            <h3 class="text-lg font-semibold mb-4">Dashboard (em desenvolvimento)</h3>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // Seus dados de configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCCA2C8c4HFx7VY6s7bh_a5n_f3O2Ogm7Y",
            authDomain: "betting-ledger-558f2.firebaseapp.com",
            projectId: "betting-ledger-558f2",
            storageBucket: "betting-ledger-558f2.firebasestorage.app",
            messagingSenderId: "68773956884",
            appId: "1:68773956884:web:1bd90aba9cefede5c88601"
        };
        
        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = app.auth();
        const db = app.firestore();
        const { getDoc, doc, collection, addDoc, getDocs, updateDoc, deleteDoc, query, where, serverTimestamp } = firebase.firestore;
        
        // Elementos HTML
        const $ = id => document.getElementById(id);
        const authContainer = $('auth-container');
        const mainContent = $('main-content');
        const loginButton = $('login-button');
        const registerButton = $('register-button');
        const emailInput = $('email-input');
        const passwordInput = $('password-input');
        const logoutButton = $('logout-button');
        const userDisplay = $('user-display');
        const betsTableBody = $('bets-table-body');
        const peoplePlatformsTableBody = $('people-platforms-table-body');

        // Formulários
        const addBetForm = $('addBetForm');
        const addPersonForm = $('addPersonForm');
        const addPlatformForm = $('addPlatformForm');
        const addTransactionForm = $('addTransactionForm');
        const betsTab = $('bets-tab');
        const peopleTab = $('people-tab');
        const dashboardTab = $('dashboard-tab');
        const tabs = [betsTab, peopleTab, dashboardTab];
        const tabContents = [$('bets-content'), $('people-content'), $('dashboard-content')];

        // Variáveis globais
        let people = [];
        let bets = [];
        let freebets = [];
        let transactions = [];
        let isDataLoaded = false;
        
        // Funções de Utilitário
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(amount);
        };
        const showTab = (tabId) => {
            tabs.forEach(tab => {
                if (tab.id === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            tabContents.forEach(content => {
                if (content.id === `${tabId.replace('-tab', '')}-content`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        };
        tabs.forEach(tab => {
            tab.addEventListener('click', () => showTab(tab.id));
        });
        showTab('bets-tab');

        // Carregar dados
        const loadPeople = async () => {
            const peopleRef = collection(db, `users/${auth.currentUser.uid}/people`);
            const peopleSnap = await getDocs(peopleRef);
            people = peopleSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const betPersonSelect = $('bet-person-id');
            const platformPersonSelect = $('platform-person-id');
            const transactionPersonSelect = $('transaction-person-id');
            const transactionPlatformSelect = $('transaction-platform-id');

            [betPersonSelect, platformPersonSelect, transactionPersonSelect].forEach(select => {
                select.innerHTML = '<option value="">Selecione uma pessoa</option>';
            });
            transactionPlatformSelect.innerHTML = '<option value="">Selecione uma plataforma</option>';

            people.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                [betPersonSelect, platformPersonSelect, transactionPersonSelect].forEach(select => select.appendChild(option.cloneNode(true)));
            });

            platformPersonSelect.addEventListener('change', () => {
                const selectedPerson = people.find(p => p.id === platformPersonSelect.value);
                transactionPlatformSelect.innerHTML = '<option value="">Selecione uma plataforma</option>';
                if (selectedPerson) {
                    selectedPerson.platforms.forEach(plat => {
                        const option = document.createElement('option');
                        option.value = plat.id;
                        option.textContent = plat.name;
                        transactionPlatformSelect.appendChild(option);
                    });
                }
            });
            renderPeoplePlatforms();
        };

        const loadBets = async () => {
            const betsRef = collection(db, `users/${auth.currentUser.uid}/bets`);
            const betsSnap = await getDocs(betsRef);
            bets = betsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderBets(bets);
        };
        const loadTransactions = async () => {
            const transactionsRef = collection(db, `users/${auth.currentUser.uid}/transactions`);
            const transactionsSnap = await getDocs(transactionsRef);
            transactions = transactionsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        };
        const loadFreebets = async () => { /* Implementar */ };
        const loadWithdrawals = async () => { /* Implementar */ };

        const updateAll = async () => {
            await loadPeople();
            await loadBets();
            await loadTransactions();
            loadFreebets();
            loadWithdrawals();

            // Calcular saldos
            const platformBalances = {};
            
            // Adicionar lucros de apostas
            bets.forEach(bet => {
                if (!platformBalances[bet.platformId]) {
                    platformBalances[bet.platformId] = {
                        name: bet.platformName,
                        balance: 0
                    };
                }
                platformBalances[bet.platformId].balance += bet.profit;
            });

            // Adicionar transações (depósitos/saques)
            transactions.forEach(t => {
                if (platformBalances[t.platformId]) {
                    if (t.type === 'Deposit') {
                        platformBalances[t.platformId].balance += t.amount;
                    } else if (t.type === 'Withdrawal') {
                        platformBalances[t.platformId].balance -= t.amount;
                    }
                }
            });
        };

        // Renderizar tabelas
        const renderBets = (betsToRender) => {
            betsTableBody.innerHTML = '';
            betsToRender.forEach(bet => {
                const resultColorClass = bet.result === 'Green' ? 'text-green-500' : bet.result === 'Red' ? 'text-red-500' : 'text-neutral-400';
                const profitColorClass = bet.profit > 0 ? 'text-green-500' : bet.profit < 0 ? 'text-red-500' : 'text-neutral-400';
                const row = document.createElement('tr');
                row.className = 'border-b border-zinc-700 hover:bg-zinc-700';
                row.innerHTML = `
                    <td class="px-4 py-2 text-sm text-neutral-400">${new Date(bet.date).toLocaleDateString()}</td>
                    <td class="px-4 py-2 text-sm text-neutral-400">${bet.description}</td>
                    <td class="px-4 py-2 text-sm text-neutral-400">${bet.personName}</td>
                    <td class="px-4 py-2 text-sm text-neutral-400">${bet.platformName}</td>
                    <td class="px-4 py-2 text-sm text-neutral-400">${bet.type}</td>
                    <td class="px-4 py-2 text-sm text-neutral-400">${formatCurrency(bet.stake)}</td>
                    <td class="px-4 py-2 text-sm text-neutral-400">${bet.odds}</td>
                    <td class="px-4 py-2 text-sm font-semibold ${resultColorClass}">${bet.result}</td>
                    <td class="px-4 py-2 text-sm text-neutral-400">${formatCurrency(bet.return)}</td>
                    <td class="px-4 py-2 text-sm font-semibold ${profitColorClass}">${formatCurrency(bet.profit)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium">
                        <button class="delete-bet-btn bg-red-500 text-white px-2 py-1 rounded-md text-xs hover:bg-red-700 transition duration-300" data-id="${bet.id}">
                            <i class="fas fa-trash-alt"></i> Excluir
                        </button>
                    </td>
                `;
                betsTableBody.appendChild(row);
            });
            document.querySelectorAll('.delete-bet-btn').forEach(button => {
                button.addEventListener('click', (e) => deleteBet(e.target.closest('button').dataset.id));
            });
        };

        const renderPeoplePlatforms = () => {
            peoplePlatformsTableBody.innerHTML = '';
            people.forEach(person => {
                if (person.platforms && person.platforms.length > 0) {
                    person.platforms.forEach(platform => {
                        const row = document.createElement('tr');
                        row.className = 'bg-zinc-700';
                        row.innerHTML = `
                            <td class="px-4 py-2 font-bold">${person.name}</td>
                            <td class="px-4 py-2 text-sm text-neutral-400">${platform.name}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium">
                                <button class="delete-platform-btn bg-red-500 text-white px-2 py-1 rounded-md text-xs hover:bg-red-700 transition duration-300" data-person-id="${person.id}" data-platform-id="${platform.id}">
                                    <i class="fas fa-trash-alt"></i> Excluir Plataforma
                                </button>
                            </td>
                        `;
                        peoplePlatformsTableBody.appendChild(row);
                    });
                }
            });
            document.querySelectorAll('.delete-platform-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const personId = e.target.closest('button').dataset.personId;
                    const platformId = e.target.closest('button').dataset.platformId;
                    deletePlatform(personId, platformId);
                });
            });
        };
        
        // Funções de Gerenciamento de Dados (Adicionar/Deletar)
        
        // Adicionar Aposta
        addBetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const date = $('date').value;
            const description = $('description').value;
            const personId = $('bet-person-id').value;
            const platformId = $('bet-platform-id').value;
            const type = $('type').value;
            const stake = parseFloat($('stake').value);
            const odds = parseFloat($('odds').value);
            const result = $('result').value;

            let profit = 0;
            let retorno = 0;
            if (result === 'Green') {
                retorno = stake * odds;
                profit = retorno - stake;
            } else if (result === 'Half Green') {
                retorno = (stake * odds) / 2 + stake / 2;
                profit = retorno - stake;
            } else if (result === 'Red') {
                profit = -stake;
            } else if (result === 'Half Red') {
                profit = -stake / 2;
            } else if (result === 'Void') {
                profit = 0;
                retorno = stake;
            }

            const person = people.find(p => p.id === personId);
            const platform = person.platforms.find(p => p.id === platformId);

            try {
                await addDoc(collection(db, `users/${auth.currentUser.uid}/bets`), {
                    date,
                    description,
                    personId,
                    personName: person.name,
                    platformId,
                    platformName: platform.name,
                    type,
                    stake,
                    odds,
                    result,
                    return: retorno,
                    profit,
                });
                alert('Aposta adicionada com sucesso!');
                addBetForm.reset();
                updateAll();
            } catch (e) {
                console.error("Erro ao adicionar aposta: ", e);
                alert('Erro ao adicionar aposta. Tente novamente.');
            }
        });

        // Deletar Aposta
        const deleteBet = async (id) => {
            if (confirm('Tem certeza que deseja excluir esta aposta?')) {
                try {
                    await deleteDoc(doc(db, `users/${auth.currentUser.uid}/bets`, id));
                    alert('Aposta excluída com sucesso!');
                    updateAll();
                } catch (e) {
                    console.error("Erro ao excluir aposta: ", e);
                    alert('Erro ao excluir aposta. Tente novamente.');
                }
            }
        };

        // Adicionar Pessoa
        addPersonForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const personName = $('person-name-input').value;
            if (personName.trim() === '') {
                alert('Por favor, digite um nome válido.');
                return;
            }
            try {
                await addDoc(collection(db, `users/${auth.currentUser.uid}/people`), {
                    name: personName,
                    platforms: []
                });
                alert('Pessoa adicionada com sucesso!');
                addPersonForm.reset();
                updateAll();
            } catch (e) {
                console.error("Erro ao adicionar pessoa: ", e);
                alert('Erro ao adicionar pessoa. Tente novamente.');
            }
        });

        // Deletar Pessoa
        const deletePerson = async (id) => {
            if (confirm('Tem certeza que deseja excluir esta pessoa?')) {
                try {
                    await deleteDoc(doc(db, `users/${auth.currentUser.uid}/people`, id));
                    alert('Pessoa excluída com sucesso!');
                    updateAll();
                } catch (e) {
                    console.error("Erro ao excluir pessoa: ", e);
                    alert('Erro ao excluir pessoa. Tente novamente.');
                }
            }
        };

        // Adicionar Plataforma
        addPlatformForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const personId = $('platform-person-id').value;
            const name = $('platform-name').value;
            if (personId && name) {
                try {
                    const personRef = doc(db, `users/${auth.currentUser.uid}/people`, personId);
                    const personDoc = await getDoc(personRef);
                    if (personDoc.exists()) {
                        const personData = personDoc.data();
                        const newPlatformId = Math.random().toString(36).substring(2, 10);
                        personData.platforms.push({ id: newPlatformId, name: name });
                        await updateDoc(personRef, { platforms: personData.platforms });
                        alert('Plataforma adicionada com sucesso!');
                        addPlatformForm.reset();
                        updateAll();
                    }
                } catch (e) {
                    console.error("Erro ao adicionar plataforma: ", e);
                    alert('Erro ao adicionar plataforma. Tente novamente.');
                }
            }
        });

        // Deletar Plataforma
        const deletePlatform = async (personId, platformId) => {
            if (confirm('Tem certeza que deseja excluir esta plataforma?')) {
                try {
                    const personRef = doc(db, `users/${auth.currentUser.uid}/people`, personId);
                    const personDoc = await getDoc(personRef);
                    if (personDoc.exists()) {
                        const personData = personDoc.data();
                        const updatedPlatforms = personData.platforms.filter(p => p.id !== platformId);
                        await updateDoc(personRef, { platforms: updatedPlatforms });
                        alert('Plataforma excluída com sucesso!');
                        updateAll();
                    }
                } catch (e) {
                    console.error("Erro ao excluir plataforma: ", e);
                    alert('Erro ao excluir plataforma. Tente novamente.');
                }
            }
        };
        
        // Adicionar Transação
        addTransactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const personId = document.getElementById('transaction-person-id').value;
            const platformId = document.getElementById('transaction-platform-id').value;
            const type = document.getElementById('transaction-type').value;
            const amount = parseFloat(document.getElementById('transaction-amount').value);

            if (personId && platformId && type && amount) {
                const transactionRef = collection(db, `users/${auth.currentUser.uid}/transactions`);
                try {
                    await addDoc(transactionRef, {
                        personId,
                        platformId,
                        type,
                        amount,
                        timestamp: serverTimestamp()
                    });
                    alert('Transação adicionada com sucesso!');
                    addTransactionForm.reset();
                    updateAll();
                } catch (e) {
                console.error("Erro ao adicionar transação: ", e);
                alert('Erro ao adicionar transação. Tente novamente.');
            }
            }
        });

        // Autenticação e Carregamento
        auth.onAuthStateChanged(user => {
            if (user) {
                authContainer.style.display = 'none';
                mainContent.style.display = 'block';
                userDisplay.textContent = `Olá, ${user.email}`;
                if (!isDataLoaded) {
                    updateAll();
                    isDataLoaded = true;
                }
            } else {
                authContainer.style.display = 'block';
                mainContent.style.display = 'none';
                userDisplay.textContent = '';
                isDataLoaded = false;
            }
        });

        loginButton.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            auth.signInWithEmailAndPassword(email, password)
                .then(() => alert('Login realizado com sucesso!'))
                .catch(error => alert('Erro ao fazer login: ' + error.message));
        });

        registerButton.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            auth.createUserWithEmailAndPassword(email, password)
                .then(() => alert('Cadastro realizado com sucesso! Pode entrar.'))
                .catch(error => alert('Erro ao cadastrar: ' + error.message));
        });

        logoutButton.addEventListener('click', () => auth.signOut());
    </script>
</body>
</html>