<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Bankroll</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif';
            background-color: #0c0c0c;
            color: #E5E5E5;
        }
        .lds-dual-ring {
            display: inline-block;
            width: 20px;
            height: 20px;
        }
        .lds-dual-ring:after {
            content: " ";
            display: block;
            width: 16px;
            height: 16px;
            margin: 1px;
            border-radius: 50%;
            border: 3px solid #fff;
            border-color: #A3A3A3 transparent #A3A3A3 transparent;
            animation: lds-dual-ring 1.2s linear infinite;
        }
        @keyframes lds-dual-ring {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button.active {
            border-bottom: 2px solid white;
        }
        /* Estilos para as telas de autenticação */
        .auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #0c0c0c;
            color: #E5E5E5;
        }
        .auth-form {
            background-color: #1a1a1a;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }
        .auth-form input {
            background-color: #262626;
            border: 1px solid #4a4a4a;
            color: #E5E5E5;
            padding: 0.75rem;
            border-radius: 0.375rem;
            width: 100%;
            margin-bottom: 1rem;
        }
        .auth-form button {
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem;
            border-radius: 0.375rem;
            width: 100%;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .auth-form button:hover {
            background-color: #4338ca;
        }
        .auth-toggle {
            margin-top: 1rem;
            color: #a3a3a3;
            cursor: pointer;
        }
        .auth-toggle:hover {
            color: #E5E5E5;
        }
    </style>
</head>
<body class="bg-zinc-950 text-neutral-200 p-4 min-h-screen flex flex-col items-center">

    <!-- Tela de Autenticação -->
    <div id="auth-screen" class="auth-container">
        <div class="auth-form">
            <h2 id="auth-title" class="text-2xl font-bold text-center mb-6 text-white">Login</h2>
            <div id="auth-message" class="hidden p-3 mb-4 rounded-md text-sm text-center"></div>
            <input type="email" id="auth-email" placeholder="Email" required>
            <input type="password" id="auth-password" placeholder="Senha" required>
            <button id="auth-submit-btn">Entrar</button>
            <p id="auth-toggle" class="auth-toggle text-center">Não tem uma conta? Cadastre-se</p>
        </div>
    </div>

    <!-- Conteúdo da Planilha (Inicialmente oculto) -->
    <div id="app-content" class="container mx-auto p-6 bg-zinc-900 rounded-2xl shadow-lg w-full max-w-4xl hidden">
        <h1 class="text-3xl font-bold text-center mb-6 text-white">Gerenciador de Bankroll</h1>
        
        <nav class="flex justify-center border-b border-zinc-700 mb-8">
            <button id="btn-tab-gerenciador" class="tab-button active px-4 py-2 text-white font-semibold transition-colors duration-200">
                Apostas
            </button>
            <button id="btn-tab-historico" class="tab-button px-4 py-2 text-neutral-400 font-semibold hover:text-white transition-colors duration-200">
                Histórico
            </button>
            <button id="btn-tab-freebets" class="tab-button px-4 py-2 text-neutral-400 font-semibold hover:text-white transition-colors duration-200">
                Freebets
            </button>
            <button id="btn-tab-pessoas" class="tab-button px-4 py-2 text-neutral-400 font-semibold hover:text-white transition-colors duration-200">
                Pessoas & Plataformas
            </button>
            <button id="btn-tab-ganhos" class="tab-button px-4 py-2 text-neutral-400 font-semibold hover:text-white transition-colors duration-200">
                Levantamento de Ganhos
            </button>
            <button id="btn-logout" class="px-4 py-2 text-red-400 font-semibold hover:text-red-300 transition-colors duration-200">
                Sair
            </button>
        </nav>

        <div id="tab-gerenciador" class="tab-content active">
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-zinc-800 p-4 rounded-xl text-center shadow-inner">
                    <p class="text-sm text-neutral-400">Bankroll Atual</p>
                    <p id="current-bankroll" class="text-xl font-bold mt-1 text-white">R$ 0,00</p>
                </div>
                <div class="bg-zinc-800 p-4 rounded-xl text-center shadow-inner">
                    <p class="text-sm text-neutral-400">Lucro/Prejuízo</p>
                    <p id="profit-loss" class="text-xl font-bold mt-1 text-white">R$ 0,00</p>
                </div>
                <div class="bg-zinc-800 p-4 rounded-xl text-center shadow-inner">
                    <p class="text-sm text-neutral-400">Total de Apostas</p>
                    <p id="total-bets" class="text-xl font-bold mt-1 text-white">0</p>
                </div>
                <div class="bg-zinc-800 p-4 rounded-xl text-center shadow-inner">
                    <p class="text-sm text-neutral-400">ROI (%)</p>
                    <p id="roi" class="text-xl font-bold mt-1 text-white">0.00%</p>
                </div>
            </div>

            <div class="bg-zinc-800 p-6 rounded-2xl shadow-inner mb-8">
                <h2 class="text-xl font-bold mb-4 text-white" id="bet-form-title">Adicionar Nova Aposta</h2>
                <form id="bet-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label for="date" class="block text-sm font-medium text-neutral-300">Data</label>
                        <input type="date" id="date" class="mt-1 block w-full rounded-md border-zinc-700 bg-zinc-900 text-neutral-200 p-2 shadow-sm focus:border-white focus:ring focus:ring-neutral-400 focus:ring-opacity-50" required>
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium text-neutral-300">Evento / Descrição</label>
                        <input type="text" id="description" placeholder="Ex: Jogo de futebol" class="mt-1 block w-full rounded-md border-zinc-700 bg-zinc-900 text-neutral-200 p-2 shadow-sm focus:border-white focus:ring focus:ring-neutral-400 focus:ring-opacity-50" required>
                    </div>
                    <div>
                        <label for="person" class="block text-sm font-medium text-neutral-300">Pessoa</label>
                        <select id="person" class="mt-1 block w-full rounded-md border-zinc-700 bg-zinc-900 text-neutral-200 p-2 shadow-sm focus:border-white focus:ring focus:ring-neutral-400 focus:ring-opacity-50" required>
                            <option value="">Selecione a Pessoa</option>
                        </select>
                    </div>
                    <div>
                        <label for="platform" class="block text-sm font-medium text-neutral-300">Plataforma</label>
                        <select id="platform" class="mt-1 block w-full rounded-md border-zinc-700 bg-zinc-900 text-neutral-200 p-2 shadow-sm focus:border-white focus:ring focus:ring-neutral-400 focus:ring-opacity-50" required disabled>
                            <option value="">Selecione a Plataforma</option>
                        </select>
                    </div>
                    <div>
                        <label for="type" class="block text-sm font-medium text-neutral-300">Tipo</label>
                        <select id="type" class="mt-1 block w-full rounded-md border-zinc-700 bg-zinc-900 text-neutral-200 p-2 shadow-sm focus:border-white focus:ring focus:ring-neutral-400 focus:ring-opacity-50">
                            <option value="Normal">Normal</option>
                            <option value="Missao">Missão</option>
                            <option value="Bonus">Bônus</option>
                            <option value="Freebet">Freebet</option>
                        </select>
                    </div>
                    <div>
                        <label for="stake" class="block text-sm font-medium text-neutral-300">Valor Apostado (R$)</label>
                        <input type="number" step="0.001" id="stake" placeholder="0.00" class="mt-1 block w-full rounded-md border-zinc-700 bg-zinc-900 text-neutral-200 p-2 shadow-sm focus:border-white focus:ring focus:ring-neutral-400 focus:ring-opacity-50" required>
                    </div>
                    <div>
                        <label for="odds" class="block text-sm font-medium text-neutral-300">Odds</label>
                        <input type="number" step="0.001" id="odds" placeholder="Ex: 2.50" class="mt-1 block w-full rounded-md border-zinc-700 bg-zinc-900 text-neutral-200 p-2 shadow-sm focus:border-white focus:ring focus:ring-neutral-400 focus:ring-opacity-50" required>
                    </div>
                    <div>
                        <label for="result" class="block text-sm font-medium text-neutral-300">Resultado</label>
                        <select id="result" class="mt-1 block w-full rounded-md border-zinc-700 bg-zinc-900 text-neutral-200 p-2 shadow-sm focus:border-white focus:ring focus:ring-neutral-400 focus:ring-opacity-50">
                            <option value="">Selecione</option>
                            <option value="Green">Green (Ganhou)</option>
                            <option value="Half Green">Meio Green</option>
                            <option value="Red">Red (Perdeu)</option>
                            <option value="Half Red">Meio Red</option>
                            <option value="Void">Void (Anulada)</option>
                            <option value="Aberta">Aberta (Não finalizada)</option>
                            <option value="Aberta FB">Aberta FB (não finalizado)</option>
                            <option value="Red FB">Red FB (Perdeu)</option>
                        </select>
                    </div>
                    <div class="sm:col-span-2 lg:col-span-4 flex justify-center mt-4">
                        <button type="submit" id="bet-form-button" class="w-full sm:w-auto px-6 py-2 bg-neutral-800 text-white rounded-md shadow-lg hover:bg-neutral-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-neutral-600 transition duration-300">
                            Adicionar Aposta
                        </button>
                    </div>
                </form>
            </div>
            
            <div id="message-box" class="hidden p-4 rounded-md mb-4 text-center text-sm"></div>

            <div class="bg-zinc-800 p-6 rounded-2xl shadow-inner overflow-x-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-white">Apostas Abertas</h2>
                    <button id="clear-bet-data-btn" class="px-4 py-2 text-sm bg-neutral-800 text-white rounded-md hover:bg-neutral-700 transition duration-300">
                        Limpar Todos os Dados
                    </button>
                </div>
                <table class="min-w-full divide-y divide-zinc-700">
                    <thead class="bg-zinc-900">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Data</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Descrição</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Pessoa</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Plataforma</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Tipo</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Valor Apostado</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Odds</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Resultado</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Retorno</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Lucro</th>
                            <th class="px-4 py-2 whitespace-nowrap text-sm font-medium text-neutral-400 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="bets-table-body" class="bg-zinc-900 divide-y divide-zinc-800">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div id="tab-historico" class="tab-content">
             <div class="bg-zinc-800 p-6 rounded-2xl shadow-inner overflow-x-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-white">Histórico de Apostas Finalizadas</h2>
                </div>
                <table class="min-w-full divide-y divide-zinc-700">
                    <thead class="bg-zinc-900">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Data</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Descrição</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Pessoa</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Plataforma</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Tipo</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Valor Apostado</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Odds</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Resultado</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Retorno</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Lucro</th>
                            <th class="px-4 py-2 whitespace-nowrap text-sm font-medium text-neutral-400 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body" class="bg-zinc-900 divide-y divide-zinc-800">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div id="tab-freebets" class="tab-content">
            <div class="bg-zinc-800 p-6 rounded-2xl shadow-inner mb-8">
                <h2 class="text-xl font-bold mb-4 text-white">Adicionar Freebet</h2>
                <form id="freebet-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label for="freebet-person" class="block text-sm font-medium text-neutral-300">Pessoa</label>
                        <select id="freebet-person" class="mt-1 block w-full rounded-md border-zinc-700 bg-zinc-900 text-neutral-200 p-2 shadow-sm focus:border-white focus:ring focus:ring-neutral-400 focus:ring-opacity-50" required>
                            <option value="">Selecione a Pessoa</option>
                        </select>
                    </div>
                    <div>
                        <label for="freebet-platform" class="block text-sm font-medium text-neutral-300">Plataforma</label>
                        <select id="freebet-platform" class="mt-1 block w-full rounded-md border-zinc-700 bg-zinc-900 text-neutral-200 p-2 shadow-sm focus:border-white focus:ring focus:ring-neutral-400 focus:ring-opacity-50" required disabled>
                            <option value="">Selecione a Plataforma</option>
                        </select>
                    </div>
                    <div>
                        <label for="freebet-stake" class="block text-sm font-medium text-neutral-300">Valor (R$)</label>
                        <input type="number" step="0.01" id="freebet-stake" placeholder="0.00" class="mt-1 block w-full rounded-md border-zinc-700 bg-zinc-900 text-neutral-200 p-2 shadow-sm focus:border-white focus:ring focus:ring-neutral-400 focus:ring-opacity-50" required>
                    </div>
                    <div>
                        <label for="freebet-quantity" class="block text-sm font-medium text-neutral-300">Quantidade</label>
                        <input type="number" id="freebet-quantity" value="1" min="1" class="mt-1 block w-full rounded-md border-zinc-700 bg-zinc-900 text-neutral-200 p-2 shadow-sm focus:border-white focus:ring focus:ring-neutral-400 focus:ring-opacity-50" required>
                    </div>
                    <div>
                        <label for="freebet-received" class="block text-sm font-medium text-neutral-300">Recebida?</label>
                        <select id="freebet-received" class="mt-1 block w-full rounded-md border-zinc-700 bg-zinc-900 text-neutral-200 p-2 shadow-sm focus:border-white focus:ring focus:ring-neutral-400 focus:ring-opacity-50" required>
                            <option value="sim">Sim</option>
                            <option value="nao">Não</option>
                        </select>
                    </div>
                    <div>
                        <label for="freebet-expiration" class="block text-sm font-medium text-neutral-300">Data de Vencimento</label>
                        <input type="date" id="freebet-expiration" class="mt-1 block w-full rounded-md border-zinc-700 bg-zinc-900 text-neutral-200 p-2 shadow-sm focus:border-white focus:ring focus:ring-neutral-400 focus:ring-opacity-50">
                    </div>
                    <div class="sm:col-span-2 lg:col-span-4 flex justify-center mt-4">
                        <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-neutral-800 text-white rounded-md shadow-lg hover:bg-neutral-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-neutral-600 transition duration-300">
                            Adicionar Freebet
                        </button>
                    </div>
                </form>
            </div>
            
            <div class="bg-zinc-800 p-6 rounded-2xl shadow-inner overflow-x-auto">
                <h2 class="text-xl font-bold mb-4 text-white">Freebets Não Utilizadas</h2>
                <table class="min-w-full divide-y divide-zinc-700">
                    <thead class="bg-zinc-900">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Pessoa</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Plataforma</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Valor</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Recebida?</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Vencimento</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="freebets-table-body" class="bg-zinc-900 divide-y divide-zinc-800">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="tab-pessoas" class="tab-content">
            <div id="people-list-view">
                <div class="bg-zinc-800 p-6 rounded-2xl shadow-inner mb-8">
                    <h2 class="text-xl font-bold mb-4 text-white">Adicionar Nova Pessoa</h2>
                    <form id="person-form" class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="person-name" placeholder="Nome da Pessoa" class="flex-1 rounded-md border-zinc-700 bg-zinc-900 text-neutral-200 p-2 shadow-sm focus:border-white focus:ring focus:ring-neutral-400 focus:ring-opacity-50" required>
                        <button type="submit" class="px-6 py-2 bg-neutral-800 text-white rounded-md shadow-lg hover:bg-neutral-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-neutral-600 transition duration-300">
                            Adicionar Pessoa
                        </button>
                    </form>
                </div>
                
                <div class="bg-zinc-800 p-6 rounded-2xl shadow-inner overflow-x-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-white">Pessoas Cadastradas</h2>
                        <button id="clear-people-btn" class="px-4 py-2 text-sm bg-neutral-800 text-white rounded-md hover:bg-neutral-700 transition duration-300">
                            Limpar Pessoas
                        </button>
                    </div>
                    <table class="min-w-full divide-y divide-zinc-700">
                        <thead class="bg-zinc-900">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Pessoa</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Saldo Total</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="people-table-body" class="bg-zinc-900 divide-y divide-zinc-800">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="platforms-management-view" class="hidden">
                <div class="bg-zinc-800 p-6 rounded-2xl shadow-inner mb-8">
                    <button id="back-to-people-btn" class="px-4 py-2 text-sm bg-neutral-800 text-white rounded-md hover:bg-neutral-700 transition duration-300 mb-4">
                        ← Voltar para Pessoas
                    </button>
                    <h2 class="text-xl font-bold mb-4 text-white" id="current-person-name"></h2>
                    
                    <div class="bg-zinc-700 p-4 rounded-xl shadow-inner mb-6">
                        <h3 class="text-lg font-semibold mb-2 text-neutral-200">Adicionar Nova Plataforma</h3>
                        <form id="platform-form" class="flex flex-col sm:flex-row gap-4">
                            <input type="text" id="platform-name" placeholder="Nome da Plataforma" class="flex-1 rounded-md border-zinc-600 bg-zinc-800 text-neutral-200 p-2 shadow-sm focus:border-white focus:ring focus:ring-neutral-400 focus:ring-opacity-50" required>
                            <button type="submit" class="px-6 py-2 bg-neutral-800 text-white rounded-md shadow-lg hover:bg-neutral-700">
                                Adicionar
                            </button>
                        </form>
                    </div>

                    <div class="overflow-x-auto">
                        <h3 class="text-lg font-semibold mb-2 text-neutral-200">Plataformas</h3>
                        <table class="min-w-full divide-y divide-zinc-700">
                            <thead class="bg-zinc-800">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Plataforma</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Saldo</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="platforms-table-body" class="bg-zinc-900 divide-y divide-zinc-800">
                                </tbody>
                        </table>
                    </div>
                    
                    <div id="transaction-form-container" class="hidden bg-zinc-700 p-4 rounded-xl shadow-inner mt-6">
                        <h3 class="text-lg font-bold mb-2 text-white" id="transaction-title">Ajustar Saldo</h3>
                        <div class="mb-4 text-sm text-neutral-300">Saldo Atual: <span id="current-platform-balance" class="font-bold"></span></div>
                        <form id="transaction-form">
                            <div class="mb-4">
                                <label for="transaction-amount" class="block text-sm font-medium text-neutral-300">Valor (R$)</label>
                                <input type="number" step="0.01" id="transaction-amount" placeholder="0.00" class="mt-1 block w-full rounded-md border-zinc-600 bg-zinc-800 text-neutral-200 p-2 shadow-sm" required>
                            </div>
                            <input type="hidden" id="current-platform-id">
                            <div class="flex gap-4 justify-end">
                                <button type="submit" id="btn-add-balance" class="px-6 py-2 bg-neutral-800 text-white rounded-md shadow-lg hover:bg-neutral-700 transition duration-300">
                                    Adicionar Saldo
                                </button>
                                <button type="submit" id="btn-withdraw-balance" class="px-6 py-2 bg-red-800 text-white rounded-md shadow-lg hover:bg-red-700 transition duration-300">
                                    Retirar Saldo
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="tab-ganhos" class="tab-content">
            <div class="bg-zinc-800 p-6 rounded-2xl shadow-inner mb-8">
                <h2 class="text-xl font-bold mb-4 text-white text-center">Levantamento de Ganhos</h2>
                <div id="profit-analysis-container" class="space-y-6">
                    <div id="daily-profits-section">
                        <h3 class="text-lg font-semibold text-neutral-200 mb-2">Ganhos Diários</h3>
                        <ul id="daily-list" class="space-y-2"></ul>
                    </div>
                    <div id="monthly-profits-section">
                        <h3 class="text-lg font-semibold text-neutral-200 mb-2">Ganhos Mensais</h3>
                        <ul id="monthly-list" class="space-y-2"></ul>
                    </div>
                    <div id="annual-profits-section">
                        <h3 class="text-lg font-semibold text-neutral-200 mb-2">Ganhos Anuais</h3>
                        <ul id="annual-list" class="space-y-2"></ul>
                    </div>
                </div>
                <p id="no-profit-data" class="text-neutral-400 text-sm text-center mt-4 hidden">Nenhum dado de aposta para exibir.</p>
            </div>
        </div>
    </div>

    <div class="mt-8 text-center flex justify-center space-x-4">
        <button onclick="exportData()" class="bg-indigo-600 text-white p-2 rounded-md hover:bg-indigo-700 transition-colors">
            Exportar Dados (Backup)
        </button>
        <button onclick="importData()" class="bg-indigo-600 text-white p-2 rounded-md hover:bg-indigo-700 transition-colors">
            Importar Dados
        </button>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCCA2C8c4HFx7VY6s7bh_a5n_f3O2Ogm7Y",
            authDomain: "betting-ledger-558f2.firebaseapp.com",
            projectId: "betting-ledger-558f2",
            storageBucket: "betting-ledger-558f2.firebasestorage.app",
            messagingSenderId: "68773956884",
            appId: "1:68773956884:web:1bd90aba9cefede5c88601"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore(); // Firestore instance

        // Global Variables
        let bets = [];
        let people = [];
        let unusedFreebets = [];
        let currentPersonId = null;
        let isEditingBetIndex = -1;
        let currentUser = null; // To store the authenticated user

        // DOM Elements (Authentication)
        const authScreen = document.getElementById('auth-screen');
        const appContent = document.getElementById('app-content');
        const authTitle = document.getElementById('auth-title');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authToggle = document.getElementById('auth-toggle');
        const authMessage = document.getElementById('auth-message');
        const logoutBtn = document.getElementById('btn-logout');

        let isLoginMode = true; // true for login, false for signup

        // DOM Elements (Tabs) - Existing
        const btnTabGerenciador = document.getElementById('btn-tab-gerenciador');
        const btnTabHistorico = document.getElementById('btn-tab-historico');
        const btnTabFreebets = document.getElementById('btn-tab-freebets');
        const btnTabPessoas = document.getElementById('btn-tab-pessoas');
        const btnTabGanhos = document.getElementById('btn-tab-ganhos');
        const tabGerenciador = document.getElementById('tab-gerenciador');
        const tabHistorico = document.getElementById('tab-historico');
        const tabFreebets = document.getElementById('tab-freebets');
        const tabPessoas = document.getElementById('tab-pessoas');
        const tabGanhos = document.getElementById('tab-ganhos');
        
        // DOM Elements (Bet Tab) - Existing
        const form = document.getElementById('bet-form');
        const formTitle = document.getElementById('bet-form-title');
        const formButton = document.getElementById('bet-form-button');
        const dateInput = document.getElementById('date');
        const descriptionInput = document.getElementById('description');
        const personSelect = document.getElementById('person');
        const platformSelect = document.getElementById('platform');
        const typeSelect = document.getElementById('type');
        const stakeInput = document.getElementById('stake');
        const oddsInput = document.getElementById('odds');
        const resultSelect = document.getElementById('result');
        const betsTableBody = document.getElementById('bets-table-body');
        const currentBankrollDisplay = document.getElementById('current-bankroll');
        const profitLossDisplay = document.getElementById('profit-loss');
        const totalBetsDisplay = document.getElementById('total-bets');
        const roiDisplay = document.getElementById('roi');
        const messageBox = document.getElementById('message-box');
        const clearBetDataBtn = document.getElementById('clear-bet-data-btn');

        // DOM Elements (History Tab) - Existing
        const historyTableBody = document.getElementById('history-table-body');

        // DOM Elements (Freebets Tab) - Existing
        const freebetForm = document.getElementById('freebet-form');
        const freebetPersonSelect = document.getElementById('freebet-person');
        const freebetPlatformSelect = document.getElementById('freebet-platform');
        const freebetStakeInput = document.getElementById('freebet-stake');
        const freebetQuantityInput = document.getElementById('freebet-quantity');
        const freebetReceivedSelect = document.getElementById('freebet-received');
        const freebetExpirationInput = document.getElementById('freebet-expiration');
        const freebetsTableBody = document.getElementById('freebets-table-body');
        
        // DOM Elements (People Tab) - Existing
        const peopleListView = document.getElementById('people-list-view');
        const platformsManagementView = document.getElementById('platforms-management-view');
        const personForm = document.getElementById('person-form');
        const peopleTableBody = document.getElementById('people-table-body');
        const clearPeopleBtn = document.getElementById('clear-people-btn');
        const backToPeopleBtn = document.getElementById('back-to-people-btn');
        const currentPersonName = document.getElementById('current-person-name');
        const platformForm = document.getElementById('platform-form');
        const platformsTableBody = document.getElementById('platforms-table-body');
        const transactionFormContainer = document.getElementById('transaction-form-container');
        const transactionForm = document.getElementById('transaction-form');
        const transactionAmountInput = document.getElementById('transaction-amount');
        const currentPlatformIdInput = document.getElementById('current-platform-id');
        const currentPlatformBalanceDisplay = document.getElementById('current-platform-balance');

        // DOM Elements (Profits Tab) - Existing
        const dailyList = document.getElementById('daily-list');
        const monthlyList = document.getElementById('monthly-list');
        const annualList = document.getElementById('annual-list');
        const noProfitDataMsg = document.getElementById('no-profit-data');

        // --- Utility Functions ---
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        };
        const showMessage = (message, type, targetElement = messageBox) => {
            targetElement.textContent = message;
            targetElement.style.backgroundColor = type === 'green' ? '#262626' : '#262626';
            targetElement.style.color = type === 'green' ? '#E5E5E5' : '#A3A3A3';
            targetElement.classList.remove('hidden');
            setTimeout(() => {
                targetElement.classList.add('hidden');
            }, 3000);
        };

        const resetForm = () => {
            form.reset();
            isEditingBetIndex = -1;
            formTitle.textContent = 'Adicionar Nova Aposta';
            formButton.textContent = 'Adicionar Aposta';
            populatePersonSelect();
        };

        const populatePersonSelect = () => {
            const selects = [personSelect, freebetPersonSelect];
            selects.forEach(select => {
                select.innerHTML = '<option value="">Selecione a Pessoa</option>';
                people.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    select.appendChild(option);
                });
            });
            platformSelect.disabled = true;
            platformSelect.innerHTML = '<option value="">Selecione a Plataforma</option>';
            freebetPlatformSelect.disabled = true;
            freebetPlatformSelect.innerHTML = '<option value="">Selecione a Plataforma</option>';
        };

        const populatePlatformSelect = (personId, targetSelect, selectedPlatformName = '') => {
            targetSelect.innerHTML = '<option value="">Selecione a Plataforma</option>';
            const selectedPerson = people.find(p => p.id === personId);
            if (selectedPerson) {
                targetSelect.disabled = false;
                selectedPerson.platforms.forEach(plat => {
                    const option = document.createElement('option');
                    option.value = plat.id;
                    option.textContent = plat.name;
                    targetSelect.appendChild(option);
                });
                if (selectedPlatformName) {
                    const platformOption = Array.from(targetSelect.options).find(opt => opt.textContent === selectedPlatformName);
                    if (platformOption) {
                        targetSelect.value = platformOption.value;
                    }
                }
            } else {
                targetSelect.disabled = true;
            }
        };

        personSelect.addEventListener('change', (e) => {
            populatePlatformSelect(e.target.value, platformSelect);
        });

        freebetPersonSelect.addEventListener('change', (e) => {
            populatePlatformSelect(e.target.value, freebetPlatformSelect);
        });

        // --- Tab Logic ---
        const switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active', 'text-white'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.add('text-neutral-400'));
            document.getElementById(tabId).classList.add('active');
            if (tabId === 'tab-gerenciador') {
                btnTabGerenciador.classList.add('active', 'text-white');
                renderOpenBets();
                renderSummary();
            } else if (tabId === 'tab-historico') {
                btnTabHistorico.classList.add('active', 'text-white');
                renderHistoryBets();
                renderSummary();
            } else if (tabId === 'tab-freebets') {
                btnTabFreebets.classList.add('active', 'text-white');
                renderUnusedFreebets();
            } else if (tabId === 'tab-pessoas') {
                btnTabPessoas.classList.add('active', 'text-white');
                renderPeople();
            } else if (tabId === 'tab-ganhos') {
                btnTabGanhos.classList.add('active', 'text-white');
                renderProfitAnalysis();
            }
        };

        btnTabGerenciador.addEventListener('click', () => switchTab('tab-gerenciador'));
        btnTabHistorico.addEventListener('click', () => switchTab('tab-historico'));
        btnTabFreebets.addEventListener('click', () => switchTab('tab-freebets'));
        btnTabPessoas.addEventListener('click', () => switchTab('tab-pessoas'));
        btnTabGanhos.addEventListener('click', () => switchTab('tab-ganhos'));

        // --- Data Persistence (Firebase Firestore) ---
        // These functions will replace localStorage operations
        const getUserDataRef = (userId) => {
            return db.collection('users').doc(userId);
        };

        const saveUserData = async () => {
            if (!currentUser) return;
            try {
                await getUserDataRef(currentUser.uid).set({
                    bets: bets,
                    people: people,
                    unusedFreebets: unusedFreebets
                });
                console.log("Dados salvos no Firestore!");
            } catch (error) {
                console.error("Erro ao salvar dados:", error);
                showMessage("Erro ao salvar dados.", "red");
            }
        };

        const loadUserData = async () => {
            if (!currentUser) return;
            try {
                const doc = await getUserDataRef(currentUser.uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    bets = data.bets || [];
                    people = data.people || [];
                    unusedFreebets = data.unusedFreebets || [];
                    console.log("Dados carregados do Firestore!");
                } else {
                    console.log("Nenhum dado encontrado para este usuário.");
                    bets = [];
                    people = [];
                    unusedFreebets = [];
                }
                // Re-render all UI components after loading data
                populatePersonSelect();
                renderOpenBets();
                renderHistoryBets();
                renderUnusedFreebets();
                renderPeople();
                renderSummary();
            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                showMessage("Erro ao carregar dados.", "red");
            }
        };

        // --- Authentication Logic ---
        authSubmitBtn.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;

            if (!email || !password) {
                showMessage("Por favor, preencha email e senha.", "red", authMessage);
                return;
            }

            try {
                if (isLoginMode) {
                    await auth.signInWithEmailAndPassword(email, password);
                    showMessage("Login bem-sucedido!", "green", authMessage);
                } else {
                    await auth.createUserWithEmailAndPassword(email, password);
                    showMessage("Cadastro bem-sucedido! Faça login agora.", "green", authMessage);
                    // Optionally switch to login mode after successful signup
                    isLoginMode = true;
                    authTitle.textContent = 'Login';
                    authSubmitBtn.textContent = 'Entrar';
                    authToggle.textContent = 'Não tem uma conta? Cadastre-se';
                }
            } catch (error) {
                console.error("Erro de autenticação:", error.message);
                let errorMessage = "Erro de autenticação.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Este email já está em uso.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Email inválido.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "A senha deve ter pelo menos 6 caracteres.";
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "Email ou senha incorretos.";
                }
                showMessage(errorMessage, "red", authMessage);
            }
        });

        authToggle.addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            if (isLoginMode) {
                authTitle.textContent = 'Login';
                authSubmitBtn.textContent = 'Entrar';
                authToggle.textContent = 'Não tem uma conta? Cadastre-se';
            } else {
                authTitle.textContent = 'Cadastro';
                authSubmitBtn.textContent = 'Cadastrar';
                authToggle.textContent = 'Já tem uma conta? Faça Login';
            }
            authMessage.classList.add('hidden'); // Clear message on toggle
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                showMessage("Desconectado com sucesso!", "green");
            } catch (error) {
                console.error("Erro ao sair:", error.message);
                showMessage("Erro ao sair.", "red");
            }
        });

        // Listen for authentication state changes
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                authScreen.classList.add('hidden');
                appContent.classList.remove('hidden');
                await loadUserData(); // Load user-specific data
            } else {
                currentUser = null;
                authScreen.classList.remove('hidden');
                appContent.classList.add('hidden');
                // Clear local data when logged out
                bets = [];
                people = [];
                unusedFreebets = [];
                // Reset UI
                populatePersonSelect();
                renderOpenBets();
                renderHistoryBets();
                renderUnusedFreebets();
                renderPeople();
                renderSummary();
            }
        });

        // --- Bet and History Tab Logic (Modified to use saveUserData) ---
        const calculateReturn = (stake, odds, result) => {
            if (result === 'Green') return stake * odds;
            if (result === 'Half Green') return (stake * (odds - 1) / 2) + stake;
            if (result === 'Void') return stake;
            if (result === 'Half Red') return stake / 2;
            if (result === 'Aberta' || result === 'Aberta FB' || result === 'Red FB') return 0;
            return 0; // Red
        };

        const calculateProfit = (retorno, stake, tipo, result) => {
            if (result === 'Aberta' || result === 'Aberta FB' || result === 'Red FB') return 0;
            if (tipo === 'Freebet') return retorno - stake;
            return retorno - stake;
        };
        
        const renderSummary = () => {
            let totalProfit = 0;
            let totalStaked = 0;
            
            bets.forEach(bet => {
                if (bet.result !== 'Aberta' && bet.result !== 'Aberta FB' && bet.result !== 'Red FB') {
                    const retorno = calculateReturn(bet.stake, bet.odds, bet.result);
                    const lucro = calculateProfit(retorno, bet.stake, bet.type, bet.result);
                    totalProfit += lucro;
                } else if (bet.result === 'Red FB') {
                    const lucro = calculateProfit(0, bet.stake, bet.type, bet.result);
                    totalProfit += lucro;
                }
                if (bet.result !== 'Aberta FB' && bet.result !== 'Red FB' ) {
                    totalStaked += bet.stake;
                }
            });
            
            let totalBankroll = 0;
            people.forEach(person => {
                person.platforms.forEach(platform => {
                    totalBankroll += getPlatformBalance(platform);
                });
            });

            const finalBankroll = totalBankroll;

            currentBankrollDisplay.textContent = formatCurrency(finalBankroll);
            currentBankrollDisplay.style.color = finalBankroll >= 0 ? '#E5E5E5' : '#A3A3A3';
            profitLossDisplay.textContent = formatCurrency(totalProfit);
            profitLossDisplay.style.color = totalProfit >= 0 ? '#E5E5E5' : '#A3A3A3';
            totalBetsDisplay.textContent = bets.length;
            const roi = totalStaked > 0 ? (totalProfit / totalStaked) * 100 : 0;
            roiDisplay.textContent = `${roi.toFixed(2)}%`;
            roiDisplay.style.color = roi >= 0 ? '#E5E5E5' : '#A3A3A3';
        };

        const createBetRow = (bet, index, tableBody) => {
            const row = document.createElement('tr');
            row.classList.add('hover:bg-zinc-800', 'transition-colors', 'duration-200');
            const retorno = calculateReturn(bet.stake, bet.odds, bet.result);
            const lucro = calculateProfit(retorno, bet.stake, bet.type, bet.result);
            
            const actionsHtml = `
                <button onclick="editBet(${index})" class="text-neutral-400 hover:text-white transition-colors duration-200" title="Editar">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.5-6.5l-3.5 3.5m-2.5-2.5l-3.5 3.5m-2.5-2.5l-3.5 3.5m-2.5-2.5l-3.5 3.5M19 8.5V11m0 0l-4 4m4-4l-4 4"></path>
                    </svg>
                </button>
                <button onclick="duplicateBet(${index})" class="text-neutral-400 hover:text-white transition-colors duration-200" title="Duplicar">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                </button>
                <button onclick="removeBet(${index})" class="text-red-400 hover:text-red-300 transition-colors duration-200" title="Excluir">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            `;

            row.innerHTML = `
                <td class="px-4 py-2 whitespace-nowrap text-sm">${bet.date}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm">${bet.description}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm">${bet.person || 'N/A'}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm">${bet.platform || 'N/A'}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm">${bet.type}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm">${formatCurrency(bet.stake)}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm">${bet.odds}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm">${bet.result}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm">${formatCurrency(retorno)}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm">${formatCurrency(lucro)}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm flex gap-2">
                    ${actionsHtml}
                </td>
            `;
            tableBody.appendChild(row);
        };

        const renderOpenBets = () => {
            betsTableBody.innerHTML = '';
            bets.forEach((bet, index) => {
                if (bet.result === 'Aberta' || bet.result === 'Aberta FB') {
                    createBetRow(bet, index, betsTableBody);
                }
            });
        };

        const renderHistoryBets = () => {
            historyTableBody.innerHTML = '';
            bets.forEach((bet, index) => {
                if (bet.result !== 'Aberta' && bet.result !== 'Aberta FB') {
                    createBetRow(bet, index, historyTableBody);
                }
            });
        };
        
        const loadBetForForm = (bet, isDuplicating = false) => {
            dateInput.value = bet.date;
            descriptionInput.value = bet.description;
            typeSelect.value = bet.type;
            stakeInput.value = bet.stake;
            oddsInput.value = bet.odds;
            resultSelect.value = bet.result;
            
            const person = people.find(p => p.name === bet.person);
            if (person) {
                const personOption = Array.from(personSelect.options).find(opt => opt.textContent === person.name);
                if (personOption) {
                    personSelect.value = personOption.value;
                    populatePlatformSelect(person.id, platformSelect, bet.platform);
                }
            }
            
            if (isDuplicating) {
                formTitle.textContent = 'Duplicar Aposta';
                formButton.textContent = 'Duplicar Aposta';
            } else {
                formTitle.textContent = 'Editar Aposta';
                formButton.textContent = 'Salvar Edição';
            }
        };

        const editBet = (index) => {
            const betToEdit = bets[index];
            isEditingBetIndex = index;
            loadBetForForm(betToEdit);
        };
        
        const duplicateBet = (index) => {
            const betToDuplicate = bets[index];
            isEditingBetIndex = -1; // Ensures it's a new bet
            loadBetForForm(betToDuplicate, true);
        };

        form.addEventListener('submit', async (e) => { // Added async
            e.preventDefault();
            
            const betData = {
                date: dateInput.value,
                description: descriptionInput.value,
                person: personSelect.options[personSelect.selectedIndex].text,
                platform: platformSelect.options[platformSelect.selectedIndex].text,
                type: typeSelect.value,
                stake: parseFloat(stakeInput.value),
                odds: parseFloat(oddsInput.value),
                result: resultSelect.value,
            };

            if (!betData.date || !betData.description || !betData.person || !betData.platform || isNaN(betData.stake) || isNaN(betData.odds) || !betData.result) {
                showMessage('Por favor, preencha todos os campos.', 'red');
                return;
            }

            const person = people.find(p => p.name === betData.person);
            const platform = person ? person.platforms.find(pl => pl.name === betData.platform) : null;
            const lucro = calculateProfit(calculateReturn(betData.stake, betData.odds, betData.result), betData.stake, betData.type, betData.result);

            if (isEditingBetIndex !== -1) {
                const oldBet = bets[isEditingBetIndex];
                const oldLucro = calculateProfit(calculateReturn(oldBet.stake, oldBet.odds, oldBet.result), oldBet.stake, oldBet.type, oldBet.result);
                
                const oldPerson = people.find(p => p.name === oldBet.person);
                const oldPlatform = oldPerson ? oldPerson.platforms.find(pl => pl.name === oldBet.platform) : null;

                if (oldPlatform) {
                    if (oldBet.result === 'Aberta') {
                         oldPlatform.transactions.push({
                            date: oldBet.date,
                            type: 'bet_reversal_stake',
                            amount: oldBet.stake
                        });
                    } else if (oldBet.result !== 'Aberta FB' && oldBet.result !== 'Red FB') {
                        oldPlatform.transactions.push({
                            date: oldBet.date,
                            type: 'bet_reversal',
                            amount: -oldLucro
                        });
                    }
                }

                bets[isEditingBetIndex] = betData;
                showMessage('Aposta editada com sucesso!', 'green');
            } else {
                bets.push(betData);
                showMessage('Aposta adicionada com sucesso!', 'green');
            }

            if (platform && betData.type !== 'Freebet') {
                if (betData.result === 'Aberta') {
                    platform.transactions.push({
                        date: betData.date,
                        type: 'stake',
                        amount: betData.stake
                    });
                } else if (betData.result !== 'Aberta FB' && betData.result !== 'Red FB') {
                    platform.transactions.push({
                        date: betData.date,
                        type: 'bet',
                        amount: lucro
                    });
                }
            }

            await saveUserData(); // Save data to Firestore
            resetForm();
            renderOpenBets();
            renderHistoryBets();
            renderSummary();
            renderPeople();
        });

        const removeBet = async (index) => { // Added async
            if (confirm('Tem certeza que deseja excluir esta aposta?')) {
                const betToRemove = bets[index];
                const lucro = calculateProfit(calculateReturn(betToRemove.stake, betToRemove.odds, betToRemove.result), betToRemove.stake, betToRemove.type, betToRemove.result);
                
                const person = people.find(p => p.name === betToRemove.person);
                const platform = person ? person.platforms.find(pl => pl.name === betToRemove.platform) : null;

                if (platform && betToRemove.type !== 'Freebet') {
                    if (betToRemove.result === 'Aberta') {
                        platform.transactions.push({
                            date: betToRemove.date,
                            type: 'bet_reversal_stake',
                            amount: betToRemove.stake
                        });
                    } else if (betToRemove.result !== 'Aberta FB' && betToRemove.result !== 'Red FB') {
                        platform.transactions.push({
                            date: betToRemove.date,
                            type: 'bet_reversal',
                            amount: -lucro
                        });
                    }
                    await saveUserData(); // Save data to Firestore
                    renderPeople();
                }

                bets.splice(index, 1);
                await saveUserData(); // Save data to Firestore
                renderOpenBets();
                renderHistoryBets();
                renderSummary();
                showMessage('Aposta removida com sucesso!', 'green');
            }
        };

        const clearBetData = async () => { // Added async
            if (confirm('Tem certeza que deseja limpar todos os dados de apostas?')) {
                bets = [];
                await saveUserData(); // Save empty data to Firestore
                renderOpenBets();
                renderHistoryBets();
                renderSummary();
                showMessage('Dados de apostas limpos com sucesso!', 'green');
            }
        };
        clearBetDataBtn.addEventListener('click', clearBetData);

        // --- Freebets Tab Logic (Modified to use saveUserData) ---
        const renderUnusedFreebets = () => {
            freebetsTableBody.innerHTML = '';
            unusedFreebets.forEach((freebet, index) => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-zinc-800', 'transition-colors', 'duration-200');
                
                const actionsHtml = `
                    <button onclick="useUnusedFreebet(${index})" class="px-3 py-1 bg-neutral-700 text-white text-xs rounded-md hover:bg-neutral-600 transition duration-300">
                        Usar
                    </button>
                    <button onclick="removeUnusedFreebet(${index})" class="text-red-400 hover:text-red-300 transition-colors duration-200" title="Excluir">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                `;

                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${freebet.person}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${freebet.platform}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${formatCurrency(freebet.stake)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${freebet.received === 'sim' ? 'Sim' : 'Não'}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${freebet.expiration || 'N/A'}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm flex gap-2">
                        ${actionsHtml}
                    </td>
                `;
                freebetsTableBody.appendChild(row);
            });
        };

        freebetForm.addEventListener('submit', async (e) => { // Added async
            e.preventDefault();

            const personName = freebetPersonSelect.options[freebetPersonSelect.selectedIndex].text;
            const platformName = freebetPlatformSelect.options[freebetPlatformSelect.selectedIndex].text;
            const stake = parseFloat(freebetStakeInput.value);
            const quantity = parseInt(freebetQuantityInput.value);
            const received = freebetReceivedSelect.value;
            const expiration = freebetExpirationInput.value;

            if (!personName || !platformName || isNaN(stake) || isNaN(quantity) || quantity <= 0) {
                showMessage('Por favor, preencha todos os campos obrigatórios corretamente.', 'red');
                return;
            }
            
            for (let i = 0; i < quantity; i++) {
                const freebetData = {
                    id: crypto.randomUUID(),
                    person: personName,
                    platform: platformName,
                    stake: stake,
                    received: received,
                    expiration: expiration
                };
                unusedFreebets.push(freebetData);
            }
            
            await saveUserData(); // Save data to Firestore
            freebetForm.reset();
            populatePersonSelect();
            renderUnusedFreebets();
            showMessage(`Freebet(s) adicionada(s) com sucesso!`, 'green');
        });

        const removeUnusedFreebet = async (index) => { // Added async
            if (confirm('Tem certeza que deseja excluir esta freebet?')) {
                unusedFreebets.splice(index, 1);
                await saveUserData(); // Save data to Firestore
                renderUnusedFreebets();
                showMessage('Freebet removida com sucesso!', 'green');
            }
        };

        const useUnusedFreebet = async (index) => { // Added async
            const freebetToUse = unusedFreebets[index];
            const today = new Date().toISOString().split('T')[0];
            
            if (freebetToUse.received === 'nao') {
                showMessage('Esta freebet ainda não foi recebida.', 'red');
                return;
            }

            // Preenche o formulário de aposta
            dateInput.value = today;
            descriptionInput.value = `Freebet de ${freebetToUse.stake} da plataforma ${freebetToUse.platform}`;
            stakeInput.value = freebetToUse.stake;
            typeSelect.value = 'Freebet';
            
            // Seleciona a pessoa e plataforma
            const person = people.find(p => p.name === freebetToUse.person);
            if (person) {
                personSelect.value = person.id;
                populatePlatformSelect(person.id, platformSelect, freebetToUse.platform);
            }

            // Muda para a aba de aposta
            switchTab('tab-gerenciador');

            // Remove a freebet da lista de não utilizadas
            unusedFreebets.splice(index, 1);
            await saveUserData(); // Save data to Firestore
            renderUnusedFreebets();

            showMessage('Freebet movida para o formulário de apostas. Complete os dados e adicione a aposta!', 'green');
        };

        // --- People and Platforms Tab Logic (Modified to use saveUserData) ---
        const renderPeople = () => {
            peopleListView.classList.remove('hidden');
            platformsManagementView.classList.add('hidden');
            transactionFormContainer.classList.add('hidden');
            peopleTableBody.innerHTML = '';
            people.forEach(person => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-zinc-800', 'transition-colors', 'duration-200');
                
                const totalBalance = person.platforms.reduce((acc, platform) => {
                    return acc + getPlatformBalance(platform);
                }, 0);

                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-semibold">${person.name}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${formatCurrency(totalBalance)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">
                        <button onclick="showPlatformsForPerson('${person.id}')" class="px-3 py-1 bg-neutral-700 text-white text-xs rounded-md hover:bg-neutral-600 transition duration-300 mr-2">
                            Gerenciar
                        </button>
                        <button onclick="removePerson('${person.id}')" class="text-neutral-400 hover:text-white transition-colors duration-200 text-xs">
                            Excluir
                        </button>
                    </td>
                `;
                peopleTableBody.appendChild(row);
            });
            renderSummary();
        };

        personForm.addEventListener('submit', async (e) => { // Added async
            e.preventDefault();
            const name = document.getElementById('person-name').value;
            if (name.trim() === '') return;
            const newPerson = {
                id: crypto.randomUUID(),
                name: name,
                platforms: [],
            };
            people.push(newPerson);
            await saveUserData(); // Save data to Firestore
            personForm.reset();
            renderPeople();
            populatePersonSelect();
            showMessage(`Pessoa '${name}' adicionada!`, 'green');
        });

        const removePerson = async (id) => { // Added async
            if (confirm('Tem certeza que deseja excluir esta pessoa e todos os dados de suas plataformas?')) {
                people = people.filter(p => p.id !== id);
                await saveUserData(); // Save data to Firestore
                renderPeople();
                showMessage('Pessoa removida!', 'green');
            }
        };

        const clearPeople = async () => { // Added async
            if (confirm('Tem certeza que deseja limpar todos os dados de pessoas? Esta ação não pode ser desfeita.')) {
                people = [];
                await saveUserData(); // Save empty data to Firestore
                renderPeople();
                populatePersonSelect();
                showMessage('Dados de pessoas limpos com sucesso!', 'green');
            }
        };
        clearPeopleBtn.addEventListener('click', clearPeople);

        const showPlatformsForPerson = (id) => {
            currentPersonId = id;
            peopleListView.classList.add('hidden');
            platformsManagementView.classList.remove('hidden');
            transactionFormContainer.classList.add('hidden');
            const person = people.find(p => p.id === currentPersonId);
            currentPersonName.textContent = person.name;
            renderPlatformsForPerson(person);
        };
        
        backToPeopleBtn.addEventListener('click', () => {
            currentPersonId = null;
            renderPeople();
        });
        
        const getPlatformBalance = (platform) => {
            return platform.transactions.reduce((acc, t) => {
                if (t.type === 'deposit' || t.type === 'bet' || t.type === 'bet_reversal_stake' || t.type === 'bet_reversal') {
                    return acc + t.amount;
                } else if (t.type === 'withdrawal' || t.type === 'stake') {
                    return acc - t.amount;
                }
                return acc;
            }, 0);
        };

        const renderPlatformsForPerson = (person) => {
            platformsTableBody.innerHTML = '';
            person.platforms.forEach(platform => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-zinc-800', 'transition-colors', 'duration-200');
                
                const totalBalance = getPlatformBalance(platform);

                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-semibold">${platform.name}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${formatCurrency(totalBalance)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">
                        <button onclick="showTransactionForm('${platform.id}')" class="px-3 py-1 bg-neutral-700 text-white text-xs rounded-md hover:bg-neutral-600 transition duration-300 mr-2">
                            Editar Saldo
                        </button>
                        <button onclick="removePlatform('${platform.id}')" class="text-neutral-400 hover:text-white transition-colors duration-200 text-xs">
                            Excluir
                        </button>
                    </td>
                `;
                platformsTableBody.appendChild(row);
            });
        };

        platformForm.addEventListener('submit', async (e) => { // Added async
            e.preventDefault();
            const person = people.find(p => p.id === currentPersonId);
            if (!person) return;
            const name = document.getElementById('platform-name').value;
            if (name.trim() === '') return;
            const newPlatform = {
                id: crypto.randomUUID(),
                name: name,
                transactions: [],
            };
            person.platforms.push(newPlatform);
            await saveUserData(); // Save data to Firestore
            platformForm.reset();
            renderPlatformsForPerson(person);
            populatePersonSelect();
            showMessage(`Plataforma '${name}' adicionada!`, 'green');
        });

        const removePlatform = async (id) => { // Added async
            if (confirm('Tem certeza que deseja excluir esta plataforma?')) {
                const person = people.find(p => p.id === currentPersonId);
                if (person) {
                    person.platforms = person.platforms.filter(p => p.id !== id);
                    await saveUserData(); // Save data to Firestore
                    renderPlatformsForPerson(person);
                    populatePersonSelect();
                    showMessage('Plataforma removida!', 'green');
                    transactionFormContainer.classList.add('hidden');
                }
            }
        };
        
        const showTransactionForm = (platformId) => {
            transactionFormContainer.classList.remove('hidden');
            currentPlatformIdInput.value = platformId;
            transactionAmountInput.value = '';
            
            const person = people.find(p => p.id === currentPersonId);
            const platform = person.platforms.find(p => p.id === platformId);
            const currentBalance = getPlatformBalance(platform);

            document.getElementById('current-platform-balance').textContent = formatCurrency(currentBalance);
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        };

        transactionForm.addEventListener('submit', async (e) => { // Added async
            e.preventDefault();
            const platformId = currentPlatformIdInput.value;
            const amount = parseFloat(transactionAmountInput.value);

            if (isNaN(amount) || amount <= 0) {
                showMessage('Por favor, insira um valor válido.', 'red');
                return;
            }
            
            const transactionType = e.submitter.id === 'btn-add-balance' ? 'deposit' : 'withdrawal';

            const person = people.find(p => p.id === currentPersonId);
            if (person) {
                const platform = person.platforms.find(p => p.id === platformId);
                if (platform) {
                    platform.transactions.push({ 
                        date: new Date().toISOString().split('T')[0], 
                        type: transactionType, 
                        amount: amount 
                    });
                    await saveUserData(); // Save data to Firestore
                    renderPlatformsForPerson(person);
                    transactionFormContainer.classList.add('hidden');
                    renderSummary();
                    showMessage(`Transação de ${formatCurrency(amount)} registrada!`, 'green');
                }
            }
        });

        // --- Profit Analysis Logic (No changes needed for data source) ---
        const renderProfitAnalysis = () => {
            dailyList.innerHTML = '';
            monthlyList.innerHTML = '';
            annualList.innerHTML = '';

            if (bets.length === 0) {
                noProfitDataMsg.classList.remove('hidden');
                return;
            }
            noProfitDataMsg.classList.add('hidden');

            const dailyProfits = {};
            const monthlyProfits = {};
            const annualProfits = {};

            bets.forEach(bet => {
                if (bet.result === 'Aberta' || bet.result === 'Aberta FB') return;
                
                const retorno = calculateReturn(bet.stake, bet.odds, bet.result);
                const lucro = calculateProfit(retorno, bet.stake, bet.type, bet.result);
                const date = bet.date;
                const monthYear = bet.date.substring(0, 7);
                const year = bet.date.substring(0, 4);

                if (!dailyProfits[date]) dailyProfits[date] = 0;
                dailyProfits[date] += lucro;

                if (!monthlyProfits[monthYear]) monthlyProfits[monthYear] = 0;
                monthlyProfits[monthYear] += lucro;

                if (!annualProfits[year]) annualProfits[year] = 0;
                annualProfits[year] += lucro;
            });
            
            const formatPeriod = (period) => {
                if (period.length === 4) return period;
                if (period.length === 7) {
                    const [year, month] = period.split('-');
                    return new Date(year, month - 1, 1).toLocaleString('pt-br', { month: 'long', year: 'numeric' });
                }
                const [year, month, day] = period.split('-');
                return `${day}/${month}/${year}`;
            };

            const renderList = (listElement, data) => {
                const sortedKeys = Object.keys(data).sort();
                
                sortedKeys.forEach(key => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('p-2', 'rounded-md', 'flex', 'justify-between', 'items-center', 'text-sm');
                    listItem.style.backgroundColor = 'rgb(38, 38, 38)';
                    
                    const profitForPeriod = data[key];
                    const formattedValue = formatCurrency(profitForPeriod);
                    const color = profitForPeriod >= 0 ? '#E5E5E5' : '#A3A3A3';

                    listItem.innerHTML = `
                        <span class="text-neutral-300 font-medium">${formatPeriod(key)}</span>
                        <span style="color: ${color}; font-weight: bold;">${formattedValue}</span>
                    `;
                    listElement.appendChild(listItem);
                });
            };

            renderList(dailyList, dailyProfits);
            renderList(monthlyList, monthlyProfits);
            renderList(annualList, annualProfits);
        };

        // Expose functions to global scope for HTML buttons
        window.removeBet = removeBet;
        window.editBet = editBet;
        window.duplicateBet = duplicateBet;
        window.clearBetData = clearBetData;
        window.removePerson = removePerson;
        window.clearPeople = clearPeople;
        window.showPlatformsForPerson = showPlatformsForPerson;
        window.removePlatform = removePlatform;
        window.showTransactionForm = showTransactionForm;
        window.removeUnusedFreebet = removeUnusedFreebet;
        window.useUnusedFreebet = useUnusedFreebet;
        window.renderProfitAnalysis = renderProfitAnalysis;

        // Initial load (handled by onAuthStateChanged)
        // No need to call loadBets(), loadPeople(), etc. here directly anymore.

        // Export/Import Data (Modified to use Firestore data structure)
        function exportData() {
            if (!currentUser) {
                showMessage("Faça login para exportar dados.", "red");
                return;
            }
            const data = {
                bets: bets,
                people: people,
                unusedFreebets: unusedFreebets
            };
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bankroll_data_${currentUser.uid}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage("Dados exportados com sucesso!", "green");
        }

        async function importData() {
            if (!currentUser) {
                showMessage("Faça login para importar dados.", "red");
                return;
            }
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';

            input.onchange = async function(event) {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        // Validate imported data structure if necessary
                        bets = importedData.bets || [];
                        people = importedData.people || [];
                        unusedFreebets = importedData.unusedFreebets || [];
                        
                        await saveUserData(); // Save imported data to Firestore
                        await loadUserData(); // Reload data from Firestore to ensure consistency
                        showMessage('Dados importados e salvos com sucesso!', 'green');
                    } catch (error) {
                        showMessage('Erro ao importar o arquivo. Certifique-se de que o arquivo JSON não foi modificado e está no formato correto.', 'red');
                        console.error('Erro ao ler o arquivo JSON:', error);
                    }
                };
                reader.readAsText(file);
            };

            input.click();
        }
    </script>
</body>
</html>
