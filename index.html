<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Betting Ledger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/e9c25d7677.js" crossorigin="anonymous"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c0c0c;
            color: #E5E5E5;
        }
        .lds-dual-ring {
            display: inline-block;
            width: 20px;
            height: 20px;
        }
        .lds-dual-ring:after {
            content: " ";
            display: block;
            width: 16px;
            height: 16px;
            margin: 1px;
            border-radius: 50%;
            border: 3px solid #fff;
            border-color: #A3A3A3 transparent #A3A3A3 transparent;
            animation: lds-dual-ring 1.2s linear infinite;
        }
        @keyframes lds-dual-ring {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-zinc-900 min-h-screen flex flex-col">

    <div id="auth-container" class="auth-container bg-zinc-800 p-8 rounded-lg shadow-xl w-full max-w-sm mx-auto my-auto text-neutral-200">
        <h2 class="text-2xl font-bold mb-6 text-center text-white">Betting Ledger</h2>
        <div class="mb-4">
            <label for="email" class="block text-sm font-medium text-neutral-400 mb-1">Email</label>
            <input type="email" id="email" class="w-full px-3 py-2 bg-zinc-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="seu-email@exemplo.com">
        </div>
        <div class="mb-6">
            <label for="password" class="block text-sm font-medium text-neutral-400 mb-1">Senha</label>
            <input type="password" id="password" class="w-full px-3 py-2 bg-zinc-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="********">
        </div>
        <div class="flex flex-col gap-4">
            <button id="login-button" class="w-full bg-blue-600 text-white py-2 rounded-md font-semibold hover:bg-blue-700 transition duration-300">Login</button>
            <button id="register-button" class="w-full bg-zinc-600 text-white py-2 rounded-md font-semibold hover:bg-zinc-700 transition duration-300">Criar Conta</button>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-5xl hidden" id="main-content">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-white">Betting Ledger</h1>
            <button id="sign-out-btn" class="bg-red-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-600 transition duration-300 hidden">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </header>

        <section class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-zinc-800 p-4 rounded-lg shadow-md">
                <h3 class="text-neutral-400 text-sm font-medium">Bankroll Atual</h3>
                <p id="current-bankroll" class="text-xl font-bold text-white mt-1">R$ 0,00</p>
            </div>
            <div class="bg-zinc-800 p-4 rounded-lg shadow-md">
                <h3 class="text-neutral-400 text-sm font-medium">Lucro/Prejuízo</h3>
                <p id="profit-loss" class="text-xl font-bold text-green-500 mt-1">+R$ 0,00</p>
            </div>
            <div class="bg-zinc-800 p-4 rounded-lg shadow-md">
                <h3 class="text-neutral-400 text-sm font-medium">Total de Apostas</h3>
                <p id="total-bets" class="text-xl font-bold text-white mt-1">0</p>
            </div>
            <div class="bg-zinc-800 p-4 rounded-lg shadow-md">
                <h3 class="text-neutral-400 text-sm font-medium">ROI</h3>
                <p id="roi" class="text-xl font-bold text-white mt-1">0%</p>
            </div>
        </section>

        <nav class="flex space-x-2 mb-8">
            <button class="tab-btn px-4 py-2 rounded-t-lg font-semibold bg-zinc-700 text-white" data-tab="bets">Apostas</button>
            <button class="tab-btn px-4 py-2 rounded-t-lg font-semibold bg-zinc-800 text-neutral-400 hover:bg-zinc-700 transition duration-300" data-tab="history">Histórico</button>
            <button class="tab-btn px-4 py-2 rounded-t-lg font-semibold bg-zinc-800 text-neutral-400 hover:bg-zinc-700 transition duration-300" data-tab="freebets">Freebets</button>
            <button class="tab-btn px-4 py-2 rounded-t-lg font-semibold bg-zinc-800 text-neutral-400 hover:bg-zinc-700 transition duration-300" data-tab="people">Pessoas & Plataformas</button>
            <button class="tab-btn px-4 py-2 rounded-t-lg font-semibold bg-zinc-800 text-neutral-400 hover:bg-zinc-700 transition duration-300" data-tab="withdrawals">Levantamento</button>
        </nav>

        <div id="bets-tab" class="tab-content">
            <h2 class="text-2xl font-bold mb-4 text-white">Adicionar Nova Aposta</h2>
            <div class="bg-zinc-800 p-6 rounded-lg shadow-md">
                <form id="bet-form" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <div>
                            <label for="date" class="block text-sm font-medium text-neutral-400 mb-1">Data</label>
                            <input type="date" id="date" required class="w-full px-3 py-2 bg-zinc-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="description" class="block text-sm font-medium text-neutral-400 mb-1">Descrição</label>
                            <input type="text" id="description" required class="w-full px-3 py-2 bg-zinc-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="person" class="block text-sm font-medium text-neutral-400 mb-1">Pessoa</label>
                            <select id="person" required class="w-full px-3 py-2 bg-zinc-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                        </div>
                        <div>
                            <label for="platform" class="block text-sm font-medium text-neutral-400 mb-1">Plataforma</label>
                            <select id="platform" required class="w-full px-3 py-2 bg-zinc-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                        </div>
                        <div>
                            <label for="type" class="block text-sm font-medium text-neutral-400 mb-1">Tipo</label>
                            <input type="text" id="type" required class="w-full px-3 py-2 bg-zinc-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="stake" class="block text-sm font-medium text-neutral-400 mb-1">Valor da Aposta (Stake)</label>
                            <input type="number" step="0.01" id="stake" required class="w-full px-3 py-2 bg-zinc-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="odds" class="block text-sm font-medium text-neutral-400 mb-1">Odds</label>
                            <input type="number" step="0.01" id="odds" required class="w-full px-3 py-2 bg-zinc-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="result" class="block text-sm font-medium text-neutral-400 mb-1">Resultado</label>
                            <select id="result" required class="w-full px-3 py-2 bg-zinc-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="Aberta">Aberta</option>
                                <option value="Green">Green</option>
                                <option value="Red">Red</option>
                                <option value="Half Green">Half Green</option>
                                <option value="Half Red">Half Red</option>
                                <option value="Void">Void</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md font-semibold hover:bg-blue-700 transition duration-300">
                        Adicionar Aposta
                    </button>
                </form>
            </div>
            <div class="mt-8 overflow-x-auto">
                <h3 class="text-xl font-bold mb-4 text-white">Lista de Apostas Abertas</h3>
                <table class="w-full text-left table-auto">
                    <thead>
                        <tr class="bg-zinc-700">
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Data</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Descrição</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Pessoa</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Plataforma</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Tipo</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Stake</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Odds</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Resultado</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Retorno</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Lucro</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="bets-table-body" class="bg-zinc-800 divide-y divide-zinc-700">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="history-tab" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4 text-white">Histórico de Apostas</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left table-auto">
                    <thead>
                        <tr class="bg-zinc-700">
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Data</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Descrição</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Pessoa</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Plataforma</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Tipo</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Stake</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Odds</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Resultado</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Retorno</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Lucro</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body" class="bg-zinc-800 divide-y divide-zinc-700">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="freebets-tab" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4 text-white">Gerenciar Freebets</h2>
            <div class="bg-zinc-800 p-6 rounded-lg shadow-md">
                <form id="freebet-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label for="fb-person" class="block text-sm font-medium text-neutral-400 mb-1">Pessoa</label>
                            <select id="fb-person" required class="w-full px-3 py-2 bg-zinc-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                        </div>
                        <div>
                            <label for="fb-platform" class="block text-sm font-medium text-neutral-400 mb-1">Plataforma</label>
                            <select id="fb-platform" required class="w-full px-3 py-2 bg-zinc-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                        </div>
                        <div>
                            <label for="fb-stake" class="block text-sm font-medium text-neutral-400 mb-1">Valor da Freebet</label>
                            <input type="number" step="0.01" id="fb-stake" required class="w-full px-3 py-2 bg-zinc-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="fb-received" class="block text-sm font-medium text-neutral-400 mb-1">Recebida?</label>
                            <select id="fb-received" required class="w-full px-3 py-2 bg-zinc-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="sim">Sim</option>
                                <option value="nao">Não</option>
                            </select>
                        </div>
                        <div>
                            <label for="fb-expiration-date" class="block text-sm font-medium text-neutral-400 mb-1">Data de Expiração</label>
                            <input type="date" id="fb-expiration-date" class="w-full px-3 py-2 bg-zinc-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md font-semibold hover:bg-blue-700 transition duration-300">
                        Adicionar Freebet
                    </button>
                </form>
            </div>
            <div class="mt-8 overflow-x-auto">
                <h3 class="text-xl font-bold mb-4 text-white">Lista de Freebets</h3>
                <table class="w-full text-left table-auto">
                    <thead>
                        <tr class="bg-zinc-700">
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Pessoa</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Plataforma</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Valor</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Recebida</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Data de Expiração</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="freebets-table-body" class="bg-zinc-800 divide-y divide-zinc-700">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="people-tab" class="tab-content hidden">
            <div id="people-list-view">
                <h2 class="text-2xl font-bold mb-4 text-white">Gerenciar Pessoas</h2>
                <div class="bg-zinc-800 p-6 rounded-lg shadow-md mb-8">
                    <form id="person-form" class="flex gap-4">
                        <input type="text" id="person-name" placeholder="Nome da Pessoa" required class="flex-grow px-3 py-2 bg-zinc-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 transition duration-300">
                            Adicionar Pessoa
                        </button>
                    </form>
                </div>
                <div class="overflow-x-auto">
                    <h3 class="text-xl font-bold mb-4 text-white">Lista de Pessoas</h3>
                    <table class="w-full text-left table-auto">
                        <thead>
                            <tr class="bg-zinc-700">
                                <th class="px-4 py-2 text-sm font-medium text-neutral-400">Pessoa</th>
                                <th class="px-4 py-2 text-sm font-medium text-neutral-400">Saldo Total</th>
                                <th class="px-4 py-2 text-sm font-medium text-neutral-400 text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="people-table-body" class="bg-zinc-800 divide-y divide-zinc-700">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="platforms-management-view" class="hidden">
                <button id="back-to-people-btn" class="bg-zinc-600 text-white px-4 py-2 rounded-md font-semibold mb-4 hover:bg-zinc-700 transition duration-300">
                    <i class="fas fa-arrow-left"></i> Voltar para Pessoas
                </button>
                <div class="mb-4">
                    <h3 class="text-xl font-bold text-white mb-2">Plataformas de <span id="current-person-name" class="font-normal text-neutral-300"></span></h3>
                </div>
                <div class="bg-zinc-800 p-6 rounded-lg shadow-md mb-8">
                    <form id="add-platform-form" class="flex gap-4">
                        <input type="text" id="platform-name" placeholder="Nome da Plataforma" required class="flex-grow px-3 py-2 bg-zinc-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 transition duration-300">
                            Adicionar Plataforma
                        </button>
                    </form>
                </div>
                <div class="overflow-x-auto">
                    <h3 class="text-xl font-bold mb-4 text-white">Lista de Plataformas</h3>
                    <table class="w-full text-left table-auto">
                        <thead>
                            <tr class="bg-zinc-700">
                                <th class="px-4 py-2 text-sm font-medium text-neutral-400">Plataforma</th>
                                <th class="px-4 py-2 text-sm font-medium text-neutral-400">Saldo</th>
                                <th class="px-4 py-2 text-sm font-medium text-neutral-400 text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="platforms-table-body" class="bg-zinc-800 divide-y divide-zinc-700">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="withdrawals-tab" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4 text-white">Levantamento de Ganhos</h2>
            <div class="bg-zinc-800 p-6 rounded-lg shadow-md">
                <form id="withdrawal-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label for="withdrawal-person" class="block text-sm font-medium text-neutral-400 mb-1">Pessoa</label>
                            <select id="withdrawal-person" required class="w-full px-3 py-2 bg-zinc-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                        </div>
                        <div>
                            <label for="withdrawal-platform" class="block text-sm font-medium text-neutral-400 mb-1">Plataforma</label>
                            <select id="withdrawal-platform" required class="w-full px-3 py-2 bg-zinc-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                        </div>
                        <div>
                            <label for="withdrawal-amount" class="block text-sm font-medium text-neutral-400 mb-1">Valor do Levantamento</label>
                            <input type="number" step="0.01" id="withdrawal-amount" required class="w-full px-3 py-2 bg-zinc-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md font-semibold hover:bg-blue-700 transition duration-300">
                        Registrar Levantamento
                    </button>
                </form>
            </div>
            <div class="mt-8 overflow-x-auto">
                <h3 class="text-xl font-bold mb-4 text-white">Histórico de Levantamentos</h3>
                <table class="w-full text-left table-auto">
                    <thead>
                        <tr class="bg-zinc-700">
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Pessoa</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Plataforma</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Valor</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Data</th>
                            <th class="px-4 py-2 text-sm font-medium text-neutral-400">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawals-table-body" class="bg-zinc-800 divide-y divide-zinc-700">
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <div id="loading-spinner" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="flex flex-col items-center">
            <div class="lds-dual-ring mb-4"></div>
            <p class="text-white text-lg">Carregando...</p>
        </div>
    </div>
    
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    
    // Variáveis globais para os objetos do Firebase
    let db;
    let auth;

    // Elementos da UI
    const authContainer = document.getElementById('auth-container');
    const mainContent = document.getElementById('main-content');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginButton = document.getElementById('login-button');
    const registerButton = document.getElementById('register-button');
    const signOutButton = document.getElementById('sign-out-btn');

    // Variáveis Globais de Dados
    let people = [];
    let bets = [];
    let freebets = [];
    let withdrawals = [];

    // CONFIGURAÇÃO DO FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyCCA2C8c4HFx7VY6s7bh_a5n_f3O2Ogm7Y",
      authDomain: "betting-ledger-558f2.firebaseapp.com",
      projectId: "betting-ledger-558f2",
      storageBucket: "betting-ledger-558f2.firebasestorage.app",
      messagingSenderId: "68773956884",
      appId: "1:68773956884:web:1bd90aba9cefede5c88601"
    };

    // Função para inicializar o Firebase e adicionar os event listeners de login
    function initializeAndSetupApp() {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                authContainer.classList.add('hidden');
                mainContent.classList.remove('hidden');
                signOutButton.classList.remove('hidden');
                loadAllData();
            } else {
                authContainer.classList.remove('hidden');
                mainContent.classList.add('hidden');
                signOutButton.classList.add('hidden');
            }
        });

        registerButton.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            createUserWithEmailAndPassword(auth, email, password)
                .then(() => { alert('Cadastro realizado com sucesso! Pode entrar.'); })
                .catch((error) => { alert('Erro ao cadastrar: ' + error.message); });
        });

        loginButton.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            signInWithEmailAndPassword(auth, email, password)
                .then(() => { alert('Login realizado com sucesso!'); })
                .catch((error) => { alert('Erro ao fazer login: ' + error.message); });
        });
        
        signOutButton.addEventListener('click', () => {
            signOut(auth).then(() => { alert('Você saiu da sua conta.'); }).catch((error) => { alert('Erro ao sair: ' + error.message); });
        });
    }

    // Carregar todos os dados do Firestore
    const loadAllData = async () => {
        showLoading();
        await Promise.all([
            loadPeople(),
            loadBets(),
            loadFreebets(),
            loadWithdrawals()
        ]);
        updateAll();
        hideLoading();
    };

    const loadPeople = async () => {
        if (!auth.currentUser) return;
        const querySnapshot = await getDocs(collection(db, `users/${auth.currentUser.uid}/people`));
        people = await Promise.all(querySnapshot.docs.map(async doc => {
            const platformsSnapshot = await getDocs(collection(db, `users/${auth.currentUser.uid}/people/${doc.id}/platforms`));
            const platforms = platformsSnapshot.docs.map(platDoc => ({ id: platDoc.id, ...platDoc.data() }));
            const totalBalance = platforms.reduce((sum, p) => sum + (p.balance || 0), 0);
            return { id: doc.id, ...doc.data(), platforms, totalBalance };
        }));
        renderPeople(people);
        populatePersonSelects();
    };

    const loadBets = async () => {
        if (!auth.currentUser) return;
        const querySnapshot = await getDocs(collection(db, `users/${auth.currentUser.uid}/bets`));
        bets = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const openBets = bets.filter(bet => bet.result === 'Aberta');
        const finishedBets = bets.filter(bet => bet.result !== 'Aberta');
        renderBets(openBets);
        renderHistory(finishedBets);
    };

    const loadFreebets = async () => {
        if (!auth.currentUser) return;
        const querySnapshot = await getDocs(collection(db, `users/${auth.currentUser.uid}/freebets`));
        freebets = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderFreebets(freebets);
    };

    const loadWithdrawals = async () => {
        if (!auth.currentUser) return;
        const querySnapshot = await getDocs(collection(db, `users/${auth.currentUser.uid}/withdrawals`));
        withdrawals = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderWithdrawals(withdrawals);
    };

    // Funções de Renderização
    const renderBets = (betsToRender) => {
        const betsTableBody = document.getElementById('bets-table-body');
        if (!betsTableBody) return;
        betsTableBody.innerHTML = '';
        betsToRender.forEach(bet => {
            const resultColorClass = bet.result === 'Green' ? 'text-green-500' : bet.result === 'Red' ? 'text-red-500' : 'text-neutral-400';
            const profitColorClass = bet.profit > 0 ? 'text-green-500' : bet.profit < 0 ? 'text-red-500' : 'text-neutral-400';
            const row = document.createElement('tr');
            row.className = 'border-b border-zinc-700 hover:bg-zinc-700';
            row.innerHTML = `
                <td class="px-4 py-2 text-sm text-neutral-400">${bet.date}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${bet.description}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${bet.personName}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${bet.platformName}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${bet.type}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${formatCurrency(bet.stake)}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${bet.odds}</td>
                <td class="px-4 py-2 text-sm font-semibold ${resultColorClass}">${bet.result}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${formatCurrency(bet.return)}</td>
                <td class="px-4 py-2 text-sm font-semibold ${profitColorClass}">${formatCurrency(bet.profit)}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm font-medium">
                    <button class="edit-bet-btn bg-neutral-800 text-white px-2 py-1 rounded-md text-xs hover:bg-neutral-700 transition duration-300" data-id="${bet.id}">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="delete-bet-btn bg-red-500 text-white px-2 py-1 rounded-md text-xs hover:bg-red-600 transition duration-300 ml-2" data-id="${bet.id}">
                        <i class="fas fa-trash-alt"></i> Deletar
                    </button>
                </td>
            `;
            betsTableBody.appendChild(row);
        });
    };

    const renderHistory = (historyToRender) => {
        const historyTableBody = document.getElementById('history-table-body');
        if (!historyTableBody) return;
        historyTableBody.innerHTML = '';
        historyToRender.forEach(bet => {
            const resultColorClass = bet.result === 'Green' ? 'text-green-500' : bet.result === 'Red' ? 'text-red-500' : 'text-neutral-400';
            const profitColorClass = bet.profit > 0 ? 'text-green-500' : bet.profit < 0 ? 'text-red-500' : 'text-neutral-400';
            const row = document.createElement('tr');
            row.className = 'border-b border-zinc-700 hover:bg-zinc-700';
            row.innerHTML = `
                <td class="px-4 py-2 text-sm text-neutral-400">${bet.date}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${bet.description}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${bet.personName}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${bet.platformName}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${bet.type}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${formatCurrency(bet.stake)}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${bet.odds}</td>
                <td class="px-4 py-2 text-sm font-semibold ${resultColorClass}">${bet.result}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${formatCurrency(bet.return)}</td>
                <td class="px-4 py-2 text-sm font-semibold ${profitColorClass}">${formatCurrency(bet.profit)}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm font-medium">
                    <button class="edit-bet-btn bg-neutral-800 text-white px-2 py-1 rounded-md text-xs hover:bg-neutral-700 transition duration-300" data-id="${bet.id}">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="delete-bet-btn bg-red-500 text-white px-2 py-1 rounded-md text-xs hover:bg-red-600 transition duration-300 ml-2" data-id="${bet.id}">
                        <i class="fas fa-trash-alt"></i> Deletar
                    </button>
                </td>
            `;
            historyTableBody.appendChild(row);
        });
    };

    const renderFreebets = (freebetsToRender) => {
        const freebetsTableBody = document.getElementById('freebets-table-body');
        if (!freebetsTableBody) return;
        freebetsTableBody.innerHTML = '';
        freebetsToRender.forEach(fb => {
            const row = document.createElement('tr');
            row.className = 'border-b border-zinc-700 hover:bg-zinc-700';
            row.innerHTML = `
                <td class="px-4 py-2 text-sm text-neutral-400">${fb.personName}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${fb.platformName}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${formatCurrency(fb.stake)}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${fb.received === 'sim' ? 'Sim' : 'Não'}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${fb.expirationDate || 'N/A'}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm font-medium">
                    <button class="delete-freebet-btn bg-red-500 text-white px-2 py-1 rounded-md text-xs hover:bg-red-600 transition duration-300" data-id="${fb.id}">
                        <i class="fas fa-trash-alt"></i> Deletar
                    </button>
                </td>
            `;
            freebetsTableBody.appendChild(row);
        });
    };

    const renderPeople = (peopleToRender) => {
        const peopleTableBody = document.getElementById('people-table-body');
        if (!peopleTableBody) return;
        peopleTableBody.innerHTML = '';
        peopleToRender.forEach(p => {
            const row = document.createElement('tr');
            row.className = 'border-b border-zinc-700 hover:bg-zinc-700 cursor-pointer';
            row.innerHTML = `
                <td class="px-4 py-2 text-sm text-neutral-400">${p.name}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${formatCurrency(p.totalBalance)}</td>
                <td class="px-4 py-2 text-right whitespace-nowrap text-sm font-medium">
                    <button class="view-platforms-btn bg-neutral-800 text-white px-2 py-1 rounded-md text-xs hover:bg-neutral-700 transition duration-300" data-id="${p.id}">
                        <i class="fas fa-eye"></i> Ver Plataformas
                    </button>
                    <button class="delete-person-btn bg-red-500 text-white px-2 py-1 rounded-md text-xs hover:bg-red-600 transition duration-300 ml-2" data-id="${p.id}">
                        <i class="fas fa-trash-alt"></i> Deletar
                    </button>
                </td>
            `;
            peopleTableBody.appendChild(row);
        });
    };

    const renderPlatforms = (platforms, personName) => {
        const platformsTableBody = document.getElementById('platforms-table-body');
        if (!platformsTableBody) return;
        platformsTableBody.innerHTML = '';
        document.getElementById('current-person-name').textContent = personName;
        platforms.forEach(platform => {
            const row = document.createElement('tr');
            row.className = 'border-b border-zinc-700 hover:bg-zinc-700';
            row.innerHTML = `
                <td class="px-4 py-2 text-sm text-neutral-400">${platform.name}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${formatCurrency(platform.balance)}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-right">
                    <button class="edit-platform-btn bg-neutral-800 text-white px-2 py-1 rounded-md text-xs hover:bg-neutral-700 transition duration-300" data-id="${platform.id}">
                        <i class="fas fa-edit"></i> Ajustar Saldo
                    </button>
                    <button class="delete-platform-btn bg-red-500 text-white px-2 py-1 rounded-md text-xs hover:bg-red-600 transition duration-300 ml-2" data-id="${platform.id}">
                        <i class="fas fa-trash-alt"></i> Deletar Plataforma
                    </button>
                </td>
            `;
            platformsTableBody.appendChild(row);
        });
    };

    const renderWithdrawals = (withdrawalsToRender) => {
        const withdrawalsTableBody = document.getElementById('withdrawals-table-body');
        if (!withdrawalsTableBody) return;
        withdrawalsTableBody.innerHTML = '';
        withdrawalsToRender.forEach(w => {
            const row = document.createElement('tr');
            row.className = 'border-b border-zinc-700 hover:bg-zinc-700';
            row.innerHTML = `
                <td class="px-4 py-2 text-sm text-neutral-400">${w.personName}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${w.platformName}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${formatCurrency(w.amount)}</td>
                <td class="px-4 py-2 text-sm text-neutral-400">${w.date}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm font-medium">
                    <button class="delete-withdrawal-btn bg-red-500 text-white px-2 py-1 rounded-md text-xs hover:bg-red-600 transition duration-300" data-id="${w.id}">
                        <i class="fas fa-trash-alt"></i> Deletar
                    </button>
                </td>
            `;
            withdrawalsTableBody.appendChild(row);
        });
    };

    const populatePersonSelects = () => {
        const personSelects = document.querySelectorAll('#bet-form #person, #freebet-form #fb-person, #withdrawal-form #withdrawal-person');
        personSelects.forEach(select => {
            select.innerHTML = '<option value="">Selecione uma Pessoa</option>';
            people.forEach(person => {
                const option = document.createElement('option');
                option.value = person.id;
                option.textContent = person.name;
                select.appendChild(option);
            });
        });
    };
    
    // Funções de atualização
    const updateBankroll = () => {
        const totalBankroll = people.reduce((sum, p) => sum + (p.totalBalance || 0), 0);
        document.getElementById('current-bankroll').textContent = formatCurrency(totalBankroll);
    };

    const updateProfitLoss = () => {
        const totalProfitLoss = bets.reduce((sum, bet) => sum + (bet.profit || 0), 0);
        const profitLossElement = document.getElementById('profit-loss');
        if (totalProfitLoss >= 0) {
            profitLossElement.textContent = `+${formatCurrency(totalProfitLoss)}`;
            profitLossElement.classList.remove('text-red-500');
            profitLossElement.classList.add('text-green-500');
        } else {
            profitLossElement.textContent = formatCurrency(totalProfitLoss);
            profitLossElement.classList.remove('text-green-500');
            profitLossElement.classList.add('text-red-500');
        }
    };

    const updateTotalBets = () => {
        document.getElementById('total-bets').textContent = bets.length;
    };

    const updateROI = () => {
        const totalInvested = bets.reduce((sum, bet) => sum + (bet.stake || 0), 0);
        const totalProfitLoss = bets.reduce((sum, bet) => sum + (bet.profit || 0), 0);
        const roi = totalInvested > 0 ? (totalProfitLoss / totalInvested) * 100 : 0;
        document.getElementById('roi').textContent = `${roi.toFixed(2)}%`;
    };

    const updateAll = () => {
        updateBankroll();
        updateProfitLoss();
        updateTotalBets();
        updateROI();
    };

    const formatCurrency = (value) => {
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
    };

    const showLoading = () => {
        document.getElementById('loading-spinner').classList.remove('hidden');
    };

    const hideLoading = () => {
        document.getElementById('loading-spinner').classList.add('hidden');
    };

    // Event Listeners
    document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', () => {
            const tab = button.dataset.tab;
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tab}-tab`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-zinc-700', 'text-white');
                btn.classList.add('bg-zinc-800', 'text-neutral-400');
            });
            button.classList.remove('bg-zinc-800', 'text-neutral-400');
            button.classList.add('bg-zinc-700', 'text-white');
        });
    });

    const personSelect = document.getElementById('person');
    const platformSelect = document.getElementById('platform');
    personSelect.addEventListener('change', () => {
        const selectedPersonId = personSelect.value;
        const selectedPerson = people.find(p => p.id === selectedPersonId);
        platformSelect.innerHTML = '<option value="">Selecione uma Plataforma</option>';
        if (selectedPerson) {
            selectedPerson.platforms.forEach(platform => {
                const option = document.createElement('option');
                option.value = platform.id;
                option.textContent = platform.name;
                platformSelect.appendChild(option);
            });
        }
    });

    // Forms
    document.getElementById('bet-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const date = document.getElementById('date').value;
        const description = document.getElementById('description').value;
        const personId = personSelect.value;
        const platformId = platformSelect.value;
        const type = document.getElementById('type').value;
        const stake = parseFloat(document.getElementById('stake').value);
        const odds = parseFloat(document.getElementById('odds').value);
        const result = document.getElementById('result').value;

        if (!personId || !platformId) {
            alert('Por favor, selecione uma pessoa e uma plataforma.');
            return;
        }

        let profit = 0;
        let retorno = 0;
        if (result === 'Green') {
            retorno = stake * odds;
            profit = retorno - stake;
        } else if (result === 'Half Green') {
            retorno = (stake * odds) / 2 + stake / 2;
            profit = retorno - stake;
        } else if (result === 'Red') {
            profit = -stake;
        } else if (result === 'Half Red') {
            profit = -stake / 2;
        } else if (result === 'Void') {
            profit = 0;
            retorno = stake;
        }

        const person = people.find(p => p.id === personId);
        const platform = person.platforms.find(p => p.id === platformId);

        try {
            await addDoc(collection(db, `users/${auth.currentUser.uid}/bets`), {
                date, description, personId, personName: person.name, platformId, platformName: platform.name,
                type, stake, odds, result, return: retorno, profit
            });
            alert('Aposta adicionada com sucesso!');
            document.getElementById('bet-form').reset();
            loadBets();
        } catch (e) {
            console.error("Erro ao adicionar aposta: ", e);
            alert('Erro ao adicionar aposta. Tente novamente.');
        }
    });

    document.getElementById('person-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const personName = document.getElementById('person-name').value;
        try {
            await addDoc(collection(db, `users/${auth.currentUser.uid}/people`), { name: personName, });
            document.getElementById('person-name').value = '';
            alert('Pessoa adicionada com sucesso!');
            loadPeople();
        } catch (e) {
            console.error("Erro ao adicionar pessoa: ", e);
            alert('Erro ao adicionar pessoa. Tente novamente.');
        }
    });
    
    document.getElementById('add-platform-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const platformName = document.getElementById('platform-name').value;
        const currentPersonId = document.getElementById('people-table-body').getAttribute('data-current-person-id');
        if (!currentPersonId) {
            alert('Erro: Nenhuma pessoa selecionada.');
            return;
        }
        try {
            await addDoc(collection(db, `users/${auth.currentUser.uid}/people/${currentPersonId}/platforms`), { name: platformName, balance: 0 });
            document.getElementById('platform-name').value = '';
            alert('Plataforma adicionada com sucesso!');
            loadPeople();
            const person = people.find(p => p.id === currentPersonId);
            renderPlatforms(person.platforms, person.name);
        } catch (e) {
            console.error("Erro ao adicionar plataforma: ", e);
            alert('Erro ao adicionar plataforma. Tente novamente.');
        }
    });
    
    // Tabela de Pessoas e Plataformas
    const peopleTableBody = document.getElementById('people-table-body');
    if (peopleTableBody) {
        peopleTableBody.addEventListener('click', async (e) => {
            const target = e.target;
            const row = target.closest('tr');
            const personId = row.querySelector('.view-platforms-btn')?.getAttribute('data-id') || row.querySelector('.delete-person-btn')?.getAttribute('data-id');

            if (target.closest('.view-platforms-btn')) {
                const person = people.find(p => p.id === personId);
                renderPlatforms(person.platforms, person.name);
                document.getElementById('people-list-view').classList.add('hidden');
                document.getElementById('platforms-management-view').classList.remove('hidden');
                peopleTableBody.setAttribute('data-current-person-id', personId);
            } else if (target.closest('.delete-person-btn')) {
                if (confirm('Tem certeza? Isso irá deletar todas as plataformas e apostas desta pessoa.')) {
                    try {
                        const personDocRef = doc(db, `users/${auth.currentUser.uid}/people`, personId);
                        const platformsSnapshot = await getDocs(collection(personDocRef, 'platforms'));
                        const deletePlatformsPromises = platformsSnapshot.docs.map(platDoc => deleteDoc(platDoc.ref));
                        await Promise.all(deletePlatformsPromises);
                        await deleteDoc(personDocRef);
                        alert('Pessoa deletada com sucesso!');
                        loadPeople();
                    } catch (e) {
                        console.error("Erro ao deletar pessoa: ", e);
                        alert('Erro ao deletar pessoa. Tente novamente.');
                    }
                }
            }
        });
    }

    const platformsTableBody = document.getElementById('platforms-table-body');
    if (platformsTableBody) {
        platformsTableBody.addEventListener('click', async (e) => {
            const target = e.target;
            const platformId = target.closest('button').getAttribute('data-id');
            const personId = document.getElementById('people-table-body').getAttribute('data-current-person-id');

            if (target.closest('.edit-platform-btn')) {
                const newBalanceStr = prompt("Ajustar saldo para:");
                const newBalance = parseFloat(newBalanceStr);
                if (newBalanceStr !== null && !isNaN(newBalance)) {
                    try {
                        const docRef = doc(db, `users/${auth.currentUser.uid}/people/${personId}/platforms`, platformId);
                        await updateDoc(docRef, { balance: newBalance });
                        alert('Saldo atualizado!');
                        loadPeople();
                        const person = people.find(p => p.id === personId);
                        renderPlatforms(person.platforms, person.name);
                    } catch (e) {
                        alert('Erro ao atualizar saldo: ' + e.message);
                    }
                }
            } else if (target.closest('.delete-platform-btn')) {
                if (confirm('Tem certeza? Isso deletará a plataforma.')) {
                    try {
                        await deleteDoc(doc(db, `users/${auth.currentUser.uid}/people/${personId}/platforms`, platformId));
                        alert('Plataforma deletada!');
                        loadPeople();
                        const person = people.find(p => p.id === personId);
                        renderPlatforms(person.platforms, person.name);
                    } catch (e) {
                        alert('Erro ao deletar plataforma: ' + e.message);
                    }
                }
            }
        });
    }

    document.getElementById('back-to-people-btn').addEventListener('click', () => {
        document.getElementById('people-list-view').classList.remove('hidden');
        document.getElementById('platforms-management-view').classList.add('hidden');
    });

    initializeAndSetupApp();
</script>

</body>
</html>